<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>清水の森 - カフェ予約管理</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Google Fonts例 -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Zen Kurenaido', 'Meiryo', 'Montserrat', sans-serif;
      background: #6b4423; color: #fff; margin: 0; min-height: 100vh; max-width:100vw;
    }
    .container {
      max-width: 890px;
      margin: 0 auto 36px auto;
      background: #fffbe9;
      border-radius: 22px;
      box-shadow: 0 8px 40px #6b442357, 0 2px 10px #d1be9c55;
      padding: 32px 3vw 24px 3vw;
      color: #34241a;
      position: relative;
    }
    h1 {
      font-family: Montserrat, 'Zen Kurenaido', sans-serif;
      font-size: 2.2em; color: #6b4423; font-weight: 700;
      text-align: center; margin: 0 0 28px 0;
      letter-spacing: 2.5px;
      text-shadow: 0 2px 13px #d1be9c55;
    }
    form {
      background: #fffef7;
      border-radius: 15px;
      padding: 22px 2vw 14px 2vw;
      margin-bottom: 32px;
      box-shadow: 0 2px 10px #e9e3d1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px,1fr));
      gap: 15px 19px;
    }
    label { font-size:1em; font-weight:500; margin-bottom:3px; display:flex; flex-direction:column; gap:7px;}
    input, select, textarea { padding:7px 9px; border-radius:9px; border:1.6px solid #bba484; font-size:1em; background: #f8f4ea;}
    .table-choice { display: flex; flex-wrap: wrap; gap:10px 13px; margin:6px 0; align-items: center;}
    .table-checkbox {margin-right: 2px; vertical-align: middle; transform: scale(1.04);}
    .table-label {margin-right: 8px; font-size: 1em;}
    .cap-text { color: #795312; font-size:0.93em; background: #eed8b0; padding:1px 8px 2px 8px; border-radius: 10px; margin-left: 5px; box-shadow: 0 1px 4px #eed8b0b6;}
    .time-choices {display: flex; gap:10px; margin:8px 0; align-items: center; flex-wrap:wrap;}
    .time-radio {display: flex; align-items: center; background: #eed8b0; padding:7px 16px 7px 12px; border-radius: 16px; font-size: 1.01em; font-weight: 500; cursor:pointer; transition: background 0.13s;}
    .time-radio.selected {background:#6b4423;color:#fff;font-weight:700;border-color:#795c31;}
    .checkboxes {display: flex; gap:13px; margin:7px 0 0 0; align-items: center; flex-wrap:wrap;}
    textarea { min-height:32px; max-height:88px; font-size:1em; resize:vertical; margin-top:5px;}
    button, .act-btn { font-size:1.02em; padding:10px 18px; margin-top:13px; border:none; border-radius:14px; background: linear-gradient(90deg, #b7a16a 1%, #ffe7b0 90%); color: #5a3e1d; font-weight:700;}
    button:hover, .act-btn:hover { background: linear-gradient(90deg, #c4a773 5%, #e69527 99%); color:#fff;}
    h2 {margin-top:18px; font-size:1em; color:#ae874f; text-align:center;}
    .scroll-table { overflow-x:auto; margin-top:6px;}
    table { border-collapse: separate; border-spacing: 0; width:max(890px,98vw); min-width:650px; margin-bottom: 5px; box-shadow:0 1px 6px #bfa98b70;font-size:0.97em;}
    thead th { background:#ebd8b0;font-size:0.98em;letter-spacing:1px;}
    tbody tr {height:34px;}
    td { font-size: 0.99em; padding:7px 7px 6px 7px; text-align:center; background:#fffbe6;}
    td.table-no {background:#eddcb4;color:#594315;font-weight:bold;border-left:4px solid #ecd490;border-right:1.7px solid #dec792;border-radius:10px 0 0 10px;width:55px;letter-spacing:1.2px;}
    td.cap-cell { background: #f8f1d7; font-size:0.97em; color:#ad7713; font-weight:bold;}
    td.empty {background:#f8efe2;color:#aeaeae;border:1.1px dashed #efe1ca;font-style:italic;}
    td.reserved {background:#fcf4e5;color:#a65c06;font-weight:bold;border:2.3px solid #deba7e;letter-spacing:0.7px;}
    td.phone { font-size:0.97em; color:#346578; font-weight:600;}
    td.num, td.childnum { font-weight:600; }
    td.note-cell {max-width:180px;font-size:0.98em;color:#a15e10;}
    td.action-cell { background: transparent; border: none;}
    .act-btn { font-size:0.99em; border-radius:8px; border:none; margin:0 3px; padding:8px 17px; background:#dbb481;color:#60461c;font-weight:592;cursor:pointer;transition:background 0.13s;}
    .act-btn:hover { background:#c66a00;color:#fff;}
    .date-title { font-size:1.05em; margin:24px 2px 7px 12px;font-weight:bold;color:#665028;border-bottom:2px dashed #e9c49f;padding-bottom:2px;}
    .group-title { font-size:0.97em;font-weight:bold;margin:17px 0 7px 14px;color:#ad7e3d;}
    .edit-form { background:#fffbe8; padding:12px 18px; border-radius:14px; box-shadow:0 1px 6px #efd3a477; margin-bottom:13px;}
    .edit-form label, .edit-form input, .edit-form select, .edit-form textarea { font-size:0.99em;}
    .edit-form textarea { width:145px;}
    .edit-form-checks { display:flex;gap:12px;margin-top:6px;}
  </style>
  <!-- Firebase setup -->
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <h1>清水の森</h1>
    <form id="resForm">
      <label>
        日付:
        <input type="date" id="date" required>
      </label>
      <label>
        大人人数:
        <input type="number" id="numAdult" required min="0" max="10" value="1">
      </label>
      <label>
        子ども人数:
        <input type="number" id="numChild" required min="0" max="10" value="0">
      </label>
      <label style="grid-column: 1/-1;">
        テーブル番号（複数選択可）:
        <div class="table-choice" id="tableChoice"></div>
      </label>
      <label style="grid-column: 1/-1;">
        時間帯:
        <div class="time-choices" id="timeChoices"></div>
        <input type="hidden" id="time" required>
      </label>
      <label>
        名前（カタカナのみ）:
        <input type="text" id="name" pattern="^[ァ-ヴー]+$" required placeholder="例：カトウ">
      </label>
      <label>
        電話番号:
        <input type="tel" id="tel" pattern="^[0-9]+$" required placeholder="例：09012345678">
      </label>
      <label style="grid-column: 1/-1;">
        備考：
        <div class="checkboxes">
          <label><input type="checkbox" id="childPlate" value="お子様プレート">お子様プレート</label>
          <label><input type="checkbox" id="bdayPlate" value="誕生日プレート">誕生日プレート</label>
        </div>
        <textarea id="note" placeholder="ご要望など自由記入"></textarea>
      </label>
      <button type="submit">予約登録</button>
    </form>
    <h2>予約一覧</h2>
    <div class="scroll-table"><section id="listArea"></section></div>
  </div>

<script>
  // ページ表示時: ログインしてるかチェック
  if(localStorage.getItem('cafe_login')!=='ok'){window.location.href="login.html";}

  // Firebase conf（自分のconfigに差し替え!）
  const firebaseConfig = {
    apiKey: "AIzaSyDtyhHZPp4HulSRVn1hJgf003EcrBJh6_u",
    authDomain: "cafe-demo.firebaseapp.com",
    projectId: "cafe-demo",
    storageBucket: "cafe-demo.appspot.com",
    messagingSenderId: "8659190883",
    appId: "1:8659190883:web:486b059e7a7b4fdfe0b731"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const RES_COLLECTION = "shimizu_cafe_reservations";

  // テーブル定義
  const TABLE_CAPACITY = {"T1":4,"T2":4,"T4":2,"T5":2,"T6":2,"T7":2,"T8":2,"T9":2,"T10":2};
  const TABLES = Object.keys(TABLE_CAPACITY);
  const TIMES = [
    { key: "11:00", label: "11時～"},
    { key: "13:00", label: "13時～"},
    { key: "dinner", label: "ディナー" }
  ];

  // テーブルチェック生成
  function renderTableChoices(selected=[]) {
    const tc = document.getElementById("tableChoice");
    tc.innerHTML = "";
    TABLES.forEach(tNo => {
      const span = document.createElement("span");
      span.className = "table-label";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "table-checkbox";
      cb.name = "tableNo";
      cb.value = tNo;
      cb.id = "tb-"+tNo;
      if (selected.includes(tNo)) cb.checked = true;
      const label = document.createElement("label");
      label.htmlFor = "tb-"+tNo;
      label.textContent = tNo;
      const cap = document.createElement("span");
      cap.className = "cap-text";
      cap.textContent = TABLE_CAPACITY[tNo]+"人";
      label.appendChild(cap);
      span.appendChild(cb);
      span.appendChild(label);
      tc.appendChild(span);
    });
  }
  // 時間帯ラジオ風ボタン生成（イベントデリゲーション化で堅牢化）
  let selectedTime = "";
  let timeDelegationAttached = false;
  function renderTimeChoices(initKey="") {
    const tc = document.getElementById("timeChoices");
    tc.innerHTML = "";

    // 生成: data-time を付与してクリックで選べるようにする
    TIMES.forEach(t=>{
      const span = document.createElement("span");
      span.className = "time-radio";
      span.dataset.time = t.key;
      span.innerHTML = `<input type="radio" name="reserveTime" value="${t.key}" style="display:none;">${t.label}`;
      if (t.key === selectedTime) span.classList.add("selected");
      tc.appendChild(span);
    });

    // 初期値代入（必要なら再描画）
    if (initKey && TIMES.some(x=>x.key===initKey)) {
      selectedTime = initKey;
      document.getElementById("time").value = initKey;
      // 再描画して selected クラスを反映
      renderTimeChoices();
      return;
    }

    // イベントデリゲーションは一度だけアタッチ
    if (!timeDelegationAttached) {
      tc.addEventListener('click', (e) => {
        const span = e.target.closest('.time-radio');
        if (!span) return;
        const val = span.dataset.time || (span.querySelector('input') && span.querySelector('input').value);
        if (!val) return;
        selectedTime = val;
        document.getElementById("time").value = val;
        // UIを更新（非同期で呼ぶことで現在のイベントループを傷つけない）
        setTimeout(()=>{ renderTimeChoices(); }, 0);
      });
      timeDelegationAttached = true;
    }

    // selected クラスを確実に反映（delegateがある前提でも保持する）
    Array.from(tc.children).forEach(s=>{
      if (s.dataset.time === selectedTime) s.classList.add("selected");
      else s.classList.remove
