<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>清水の森 - カフェ予約管理</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <!-- External stylesheet -->
  <link rel="stylesheet" href="styles.css?v=1.0">
  <!-- Firebase setup (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="container">
    <h1>清水の森</h1>
    <form id="resForm">
      <label>
        日付:
        <input type="date" id="date" required>
      </label>
      <label>
        大人人数:
        <input type="number" id="numAdult" required min="0" max="10" value="1">
      </label>
      <label>
        子ども人数:
        <input type="number" id="numChild" required min="0" max="10" value="0">
      </label>
      <label style="grid-column: 1/-1;">
        テーブル番号（複数選択可）:
        <div class="table-choice" id="tableChoice"></div>
      </label>
      <label style="grid-column: 1/-1;">
        時間帯:
        <div class="time-choices" id="timeChoices" aria-label="時間帯選択"></div>
        <input type="hidden" id="time" required>
      </label>
      <label>
        名前（カタカナのみ）:
        <input type="text" id="name" pattern="^[ァ-ヴー]+$" placeholder="例：カトウ">
      </label>
      <label>
        電話番号:
        <input type="tel" id="tel" pattern="^[0-9]+$" placeholder="例：09012345678">
      </label>
      <label style="grid-column: 1/-1;">
        備考：
        <div class="checkboxes">
          <label><input type="checkbox" id="childPlate" value="お子様プレート">お子様プレート</label>
          <label><input type="checkbox" id="bdayPlate" value="誕生日プレート">誕生日プレート</label>
        </div>
        <textarea id="note" placeholder="ご要望など自由記入"></textarea>
      </label>
      <button type="submit">予約登録</button>
    </form>
    <h2>予約一覧</h2>
    <div class="scroll-table"><section id="listArea"></section></div>
  </div>

<script>
  // --- Firebase 設定（コンソールの Web アプリ設定に合わせてください）
  const firebaseConfig = {
    apiKey: "AIzaSyCIjAeYqS2Bbw60qU6ZUn2q04TlMFD5fdg",
    authDomain: "website-create-shimizunomori.firebaseapp.com",
    projectId: "website-create-shimizunomori",
    storageBucket: "website-create-shimizunomori.appspot.com",
    messagingSenderId: "356236905700",
    appId: "1:356236905700:web:fdae74bcebb1e29856b0f1",
    measurementId: "G-69W2528VVT"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const RES_COLLECTION = "shimizu_cafe_reservations";

  // --- 認証チェック: 未認証なら login.html にリダイレクト
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      console.log('Signed in:', user.uid, user.email || '(no email)');
      // 初期表示・取得はここで開始
      renderTableChoices();
      renderTimeChoices();
      renderList();
    } else {
      window.location.href = 'login.html';
    }
  });

  // テーブル定義
  const TABLE_CAPACITY = {"T1":4,"T2":4,"T4":2,"T5":2,"T6":2,"T7":2,"T8":2,"T9":2,"T10":2};
  const TABLES = Object.keys(TABLE_CAPACITY);
  const TIMES = [
    { key: "11:00", label: "11時～"},
    { key: "13:00", label: "13時～"},
    { key: "dinner", label: "ディナー" }
  ];

  // テーブルチェック生成
  function renderTableChoices(selected=[]) {
    const tc = document.getElementById("tableChoice");
    tc.innerHTML = "";
    TABLES.forEach(tNo => {
      const span = document.createElement("span");
      span.className = "table-label";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "table-checkbox";
      cb.name = "tableNo";
      cb.value = tNo;
      cb.id = "tb-"+tNo;
      if (selected.includes(tNo)) cb.checked = true;
      const label = document.createElement("label");
      label.htmlFor = "tb-"+tNo;
      label.textContent = tNo;
      const cap = document.createElement("span");
      cap.className = "cap-text";
      cap.textContent = TABLE_CAPACITY[tNo]+"人";
      label.appendChild(cap);
      span.appendChild(cb);
      span.appendChild(label);
      tc.appendChild(span);
    });
  }

  // 時間帯ラジオ風ボタン生成（改良版：hover/フォーカスの誤反応を防ぐ）
  let selectedTime = "";
  function renderTimeChoices(initKey="") {
    const tc = document.getElementById("timeChoices");
    if (!tc) return;
    tc.innerHTML = "";

    // 初期値がある場合は反映（initKey 優先）
    if (initKey && TIMES.some(x => x.key === initKey)) {
      selectedTime = initKey;
      const hidden = document.getElementById("time");
      if (hidden) hidden.value = initKey;
    }

    TIMES.forEach(t => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "time-radio";
      btn.setAttribute("data-time", t.key);
      btn.textContent = t.label;

      // 選択済みの反映
      if (t.key === selectedTime) btn.classList.add("selected");

      // クリック時：再描画しない（クラスの付け替えのみ）
      btn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        const prev = tc.querySelector(".time-radio.selected");
        if (prev && prev !== btn) prev.classList.remove("selected");
        btn.classList.add("selected");
        selectedTime = t.key;
        const hidden = document.getElementById("time");
        if (hidden) hidden.value = t.key;
      });

      // hover 表示は JS で hover クラスを付け外し（重なりで誤反応するケースを軽減）
      btn.addEventListener("mouseenter", () => btn.classList.add("hover"));
      btn.addEventListener("mouseleave", () => btn.classList.remove("hover"));

      tc.appendChild(btn);
    });
  }

  // 日付選択で一覧も絞り込み
  let selectedDateVal = "";
  document.getElementById("date").addEventListener("change", function(e){
    selectedDateVal = e.target.value;
    renderList(selectedDateVal);
  });

  // 予約登録
  document.getElementById("resForm").onsubmit = async function(e) {
    e.preventDefault();
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;
    const numAdult = document.getElementById("numAdult").value.trim();
    const numChild = document.getElementById("numChild").value.trim();
    const name = document.getElementById("name").value.trim();
    const tel = document.getElementById("tel").value.trim();
    const childPlate = document.getElementById("childPlate") ? document.getElementById("childPlate").checked : false;
    const bdayPlate = document.getElementById("bdayPlate") ? document.getElementById("bdayPlate").checked : false;
    const note = document.getElementById("note").value.trim();
    const tables = [];
    document.querySelectorAll("input[name=tableNo]:checked").forEach(cb => tables.push(cb.value));

    // 必須項目チェック
    if (!date || !time || numAdult==="" || numChild==="") {
      alert("日付・時間・人数は必須です");
      return;
    }
    if (name && !(/^[ァ-ヴー]+$/.test(name))) {
      alert("名前はカタカナのみで入力してください");
      return;
    }
    if (tel && !(/^[0-9]+$/.test(tel))) {
      alert("電話番号は数字のみで入力してください");
      return;
    }
    if (tables.length === 0) {
      alert("テーブル番号を選択してください");
      return;
    }

    // 重複チェック
    try {
      const snapshot = await db.collection(RES_COLLECTION)
        .where("date", "==", date).where("time", "==", time)
        .get();
      const overlap = snapshot.docs.some(doc => {
        const r = doc.data();
        return (r.tables||[]).some(t=>tables.includes(t));
      });
      if (overlap) {
        alert("選択したテーブルで既に予約があります");
        return;
      }
    } catch (err) {
      console.error('Overlap check failed', err);
      alert('予約の重複チェックに失敗しました: ' + (err.message || err));
      return;
    }

    // 登録（エラー時にわかるように try/catch）
    try {
      await db.collection(RES_COLLECTION).add({
        date, time, numAdult, numChild, tables, name, tel, childPlate, bdayPlate, note,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch (err) {
      console.error('Firestore add error', err);
      alert('予約登録に失敗しました: ' + (err.message || err));
      return;
    }

    document.getElementById("resForm").reset();
    document.getElementById("time").value = "";
    selectedTime = "";
    renderTableChoices();
    renderTimeChoices();
    selectedDateVal = date;
    renderList(selectedDateVal);
  };

  // 一覧ライブ描画
  let unsubscribe = null;
  function renderList(selectedDate) {
    const area = document.getElementById("listArea");
    area.innerHTML = "<div style='color:#aaa;padding:14px;'>読込中...</div>";
    if (unsubscribe) unsubscribe();
    unsubscribe = db.collection(RES_COLLECTION)
      .orderBy("date").orderBy("time").orderBy("createdAt")
      .onSnapshot((querySnap)=>{
        const docs = querySnap.docs.map((d,i)=>({...d.data(), _id: d.id, index:i}));
        const filtered = selectedDate ? docs.filter(r=>r.date===selectedDate) : docs;
        drawTable(filtered, selectedDate);
      }, err => {
        console.error('onSnapshot error', err);
        area.innerHTML = "<div style='color:#a00;padding:14px;'>データの読み込みに失敗しました: "+(err.message||err)+"</div>";
      });
  }

  function drawTable(res, selectedDate) {
    const area = document.getElementById("listArea");
    area.innerHTML = "";
    if (!res || res.length === 0) {
      area.innerHTML = "<div style='color:#aaa;padding:14px;'>予約はありません</div>";
      return;
    }
  
    // grouped[date][time][tableNo] = info
    const grouped = {};
    res.forEach((r, idx) => {
      (r.tables || []).forEach(tableNo => {
        if (!grouped[r.date]) grouped[r.date] = {};
        if (!grouped[r.date][r.time]) grouped[r.date][r.time] = {};
        grouped[r.date][r.time][tableNo] = {
          numAdult: r.numAdult, numChild: r.numChild, name: r.name, tel: r.tel,
          childPlate: r.childPlate, bdayPlate: r.bdayPlate, note: r.note,
          _id: r._id, index: idx, tables: r.tables
        };
      });
    });
  
    const dates = Object.keys(grouped).sort().filter(d => !selectedDate || d === selectedDate);
    dates.forEach(date => {
      const dateTitle = document.createElement("div");
      dateTitle.className = "date-title";
      dateTitle.textContent = date;
      area.appendChild(dateTitle);
  
      TIMES.forEach(({ key: timeKey, label }) => {
        const title = document.createElement("div");
        title.className = "group-title";
        title.textContent = "■" + label;
        area.appendChild(title);
  
        const tableWrap = document.createElement("div");
        tableWrap.className = "scroll-table";
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML =
          "<tr>" +
            "<th>テーブル</th><th>キャパ</th><th>大人</th><th>子ども</th><th>名前</th><th>電話番号</th><th>備考</th><th>操作</th>" +
          "</tr>";
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
  
        TABLES.forEach(tNo => {
          const tr = document.createElement("tr");
  
          const tdNo = document.createElement("td");
          tdNo.className = "table-no";
          tdNo.textContent = tNo;
          tr.appendChild(tdNo);
  
          const tdCap = document.createElement("td");
          tdCap.className = "cap-cell";
          tdCap.textContent = TABLE_CAPACITY[tNo] + "人";
          tr.appendChild(tdCap);
  
          const hasRes = grouped[date] && grouped[date][timeKey] && grouped[date][timeKey][tNo];
          if (hasRes) {
            const info = grouped[date][timeKey][tNo];
  
            const reservationTables = (info.tables || []).filter(x => TABLES.includes(x));
            const orderedResTables = TABLES.filter(t => reservationTables.includes(t));
  
            const isFirst = orderedResTables.length > 0 && orderedResTables[0] === tNo;
            if (isFirst) {
              const rowspan = Math.max(1, orderedResTables.length);
  
              // 大人
              const tdNumA = document.createElement("td");
              tdNumA.className = "num merged-cell";
              tdNumA.textContent = info.numAdult;
              tdNumA.rowSpan = rowspan;
              tdNumA.style.verticalAlign = "middle";
              tr.appendChild(tdNumA);
  
              // 子ども
              const tdNumC = document.createElement("td");
              tdNumC.className = "childnum merged-cell";
              tdNumC.textContent = info.numChild;
              tdNumC.rowSpan = rowspan;
              tdNumC.style.verticalAlign = "middle";
              tr.appendChild(tdNumC);
  
              // 名前
              const tdName = document.createElement("td");
              tdName.className = "reserved merged-cell";
              tdName.textContent = info.name || "";
              tdName.rowSpan = rowspan;
              tdName.style.verticalAlign = "middle";
              tr.appendChild(tdName);
  
              // 電話
              const tdTel = document.createElement("td");
              tdTel.className = "phone merged-cell";
              tdTel.textContent = info.tel || "";
              tdTel.rowSpan = rowspan;
              tdTel.style.verticalAlign = "middle";
              tr.appendChild(tdTel);
  
              // 備考
              const tdNote = document.createElement("td");
              tdNote.className = "note-cell merged-cell";
              let noteStr = [];
              if (info.childPlate) noteStr.push("お子様プレート");
              if (info.bdayPlate) noteStr.push("誕生日プレート");
              if (info.note && info.note.trim() !== "") noteStr.push(info.note);
              tdNote.textContent = noteStr.join("／");
              tdNote.rowSpan = rowspan;
              tdNote.style.verticalAlign = "middle";
              tdNote.style.textAlign = "center";
              tr.appendChild(tdNote);
  
              // 操作
              const tdAct = document.createElement("td");
              tdAct.className = "action-cell merged-cell";
              tdAct.rowSpan = rowspan;
              tdAct.style.verticalAlign = "middle";
              tdAct.style.textAlign = "center";
  
              const removeBtn = document.createElement("button");
              removeBtn.className = "act-btn";
              removeBtn.textContent = "削除";
              removeBtn.onclick = async () => {
                if (confirm("本当に削除してもよいですか？")) {
                  try {
                    await db.collection(RES_COLLECTION).doc(info._id).delete();
                  } catch (err) {
                    console.error('Delete failed', err);
                    alert('削除に失敗しました: ' + (err.message || err));
                  }
                }
              };
  
              const editBtn = document.createElement("button");
              editBtn.className = "act-btn";
              editBtn.textContent = "変更";
              editBtn.style.marginLeft = "8px";
              editBtn.onclick = () => { showEditForm(info, date, timeKey, tNo, selectedDate); };
  
              tdAct.appendChild(removeBtn);
              tdAct.appendChild(editBtn);
              tr.appendChild(tdAct);
            }
            // if not first table of group then merged cells are omitted here
          } else {
            // empty placeholders (columns count must match merged columns count)
            Array(6).fill(0).forEach(() => {
              const td = document.createElement("td");
              td.className = "empty";
              td.textContent = '';
              tr.appendChild(td);
            });
          }
  
          tbody.appendChild(tr);
        });
  
        table.appendChild(tbody);
        tableWrap.appendChild(table);
        area.appendChild(tableWrap);
      });
    });
  }

  // 編集フォーム（人数と備考、名前・電話も編集可能）
  function showEditForm(info, date, timeKey, tNo, selectedDate) {
    const area = document.getElementById("listArea");
    area.innerHTML = "";
    const editDiv = document.createElement("div");
    editDiv.className = "edit-form";
    editDiv.innerHTML = `
      <h3 style="margin:7px 0 13px 7px;font-size:1.02em;color:#a77f50">
        変更（${date} ${tNo} ${timeKey}）
      </h3>

      <label>名前（カタカナのみ）：
        <input type="text" id="editName" value="${info.name || ''}" placeholder="例：カトウ">
      </label>

      <label>電話番号：
        <input type="tel" id="editTel" value="${info.tel || ''}" placeholder="例：09012345678">
      </label>

      <label>大人人数：
        <input type="number" id="editNumA" value="${info.numAdult}" min="0" max="10" required>
      </label>

      <label>子ども人数：
        <input type="number" id="editNumC" value="${info.numChild}" min="0" max="10" required>
      </label>

      <div class="edit-form-checks">
        <label><input type="checkbox" id="editChildPlate" ${info.childPlate ? "checked" : ""}>お子様プレート</label>
        <label><input type="checkbox" id="editBdayPlate" ${info.bdayPlate ? "checked" : ""}>誕生日プレート</label>
      </div>

      <label>その他（自由記入）:
        <textarea id="editNote">${info.note || ""}</textarea>
      </label>

      <div style="margin-top:10px">
        <button class="act-btn" id="saveEditBtn">保存</button>
        <button class="act-btn" id="cancelEditBtn">キャンセル</button>
      </div>
    `;
    area.appendChild(editDiv);

    // 保存ボタン処理
    document.getElementById("saveEditBtn").onclick = async () => {
      const editName = document.getElementById("editName").value.trim();
      const editTel = document.getElementById("editTel").value.trim();
      const editNumA = document.getElementById("editNumA").value.trim();
      const editNumC = document.getElementById("editNumC").value.trim();
      const editChildPlate = document.getElementById("editChildPlate").checked;
      const editBdayPlate = document.getElementById("editBdayPlate").checked;
      const editNote = document.getElementById("editNote").value.trim();

      // バリデーション
      if (editNumA === "" || editNumC === "") {
        alert("人数入力必須です");
        return;
      }
      if (editName && !(/^[ァ-ヴー]+$/.test(editName))) {
        alert("名前はカタカナのみで入力してください");
        return;
      }
      if (editTel && !(/^[0-9]+$/.test(editTel))) {
        alert("電話番号は数字のみで入力してください");
        return;
      }

      try {
        await db.collection(RES_COLLECTION).doc(info._id).update({
          name: editName || null,
          tel: editTel || null,
          numAdult: editNumA,
          numChild: editNumC,
          childPlate: editChildPlate,
          bdayPlate: editBdayPlate,
          note: editNote
        });
      } catch (err) {
        console.error('Update failed', err);
        alert('更新に失敗しました: ' + (err.message || err));
      }
      renderList(selectedDate);
    };

    // キャンセル
    document.getElementById("cancelEditBtn").onclick = () => renderList(selectedDate);
  }
</script>
</body>
</html>
