<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カフェ予約管理</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --mainColor: #94653b;
      --accentColor: #ffe9c1;
      --btnColor: #ffab58;
      --btnColor2: #ffd9b3;
      --dangerColor: #ff6f00;
      --fontBig: 1.28em;
      --fontMed: 1.15em;
      --borderRadius: 19px;
    }
    body {
      font-family: 'Yu Gothic', 'Meiryo', 'sans-serif';
      background: #f8f6f3;
      color: #222;
      margin: 0; padding: 0 0 50px 0; min-height: 100vh;
      max-width:100vw; overflow-x:hidden;
    }
    h1 {
      font-size: 2.13em; color: var(--mainColor);
      background: linear-gradient(to right, #ffecd2 40%, #fcb69f 100%);
      margin: 0; padding: 32px 0 18px 0; text-align: center; font-weight: 700; box-shadow: 0 2px 8px #e5d8cd55;
    }
    .big-form {
      display: flex; flex-wrap: wrap; gap: 16px 24px;
      background: #fffde9; border-radius: var(--borderRadius);
      padding: 20px 30px 13px 18px; margin: 36px auto 22px auto;
      width: min(700px, 98vw); box-shadow: 0 2px 7px #f2e1b7b2;
      font-size: var(--fontBig);
      align-items: center;
      justify-content: flex-start;
    }
    .big-form label {
      font-size: var(--fontBig); letter-spacing:1px; font-weight:500;
      flex-basis:46%; min-width:155px; margin-bottom:6px;
      display: flex; flex-direction: column;
    }
    .big-form input, .big-form select, .big-form textarea {
      font-size: var(--fontBig);
      padding: 7px 10px;
      border-radius: 11px;
      border: 2.2px solid #d3bba3;
      background: #fff;
      margin-top:7px;
      width: 100%;
      box-sizing: border-box;
    }
    .big-form .detail-notebox label, .big-form .checkboxes label {
      font-size: 1.1em; font-weight:450; margin: 0 0 8px 0;
      flex-direction: row; align-items: center;
      gap: 5px;
    }
    .big-form .checkboxes {
      display: flex; gap:15px; margin: 7px 0 0 0; align-items: center;
      flex-wrap: wrap;
    }
    .big-form textarea {
      min-height:44px; max-height:100px;
      font-size:1.12em;
      resize:vertical;
      margin-top:6px;
    }
    .table-choice {
      display: flex; flex-wrap: wrap; gap: 7px 13px; margin: 6px 0;
      align-items: center;
    }
    .table-checkbox {margin-right: 2px; vertical-align: middle; transform: scale(1.22);}
    .table-label {margin-right: 11px; font-size: 1.11em;}
    .cap-text {
      color: #815d0c;
      font-size: 0.99em;
      background: #ffd9b3;
      padding: 2px 7px 1px 7px;
      border-radius: 11px;
      margin-left: 5px;
      letter-spacing: 1px;
    }
    .time-choices {
      display: flex; gap: 11px; margin-top: 7px; margin-bottom: 7px;
      flex-wrap: wrap;
    }
    .time-radio {
      display: flex; align-items: center;
      background: var(--accentColor);
      padding: 7px 17px 7px 13px;
      border-radius: 18px;
      font-size: var(--fontMed);
      font-weight:500;
      letter-spacing: 1px;
      cursor: pointer;
      transition: background 0.15s, color 0.14s, font-weight 0.13s;
      box-shadow: 0 0.5px 2px #fcbbc066;
    }
    .time-radio.selected {
      background: var(--btnColor);
      color: #fff;
      box-shadow: 0 1px 7px var(--btnColor);
      font-weight: bold;
    }
    button, .act-btn {
      font-size: 1.15em; padding: 11px 33px; margin-top: 18px;
      border: none; border-radius: 14px;
      background: linear-gradient(90deg, var(--btnColor2) 3%, var(--btnColor) 100%);
      color: #744d29; font-weight: bold; cursor: pointer; transition: background 0.15s;
      box-shadow: 0 1px 4px #efd2a588;
    }
    button:hover, .act-btn:hover { background: linear-gradient(90deg, var(--btnColor2) 1%, var(--dangerColor) 99%); color: #fff;}
    h2{margin-top:36px; font-size:1.4em; color: #b05c1e; text-align:center; }
    #listArea { width: min(990px, 99vw); margin: 18px auto 0 auto; background: #fffdfa; border-radius: var(--borderRadius); box-shadow: 0 2px 12px #ecd4af66; padding: 22px 8px 29px 8px;}
    .date-title { font-size:1.07em; margin: 27px 2px 10px 10px; font-weight: bold; color: #564400; text-shadow: 0 1px 2px #ffeec9, 0 0 2px #fff; border-bottom: 2px dashed #e9c49f; padding-bottom: 3px;}
    .group-title { font-size:0.98em; font-weight:bold; margin: 17px 0 7px 15px; color: #b85d21;}
    table { border-collapse: separate; border-spacing: 0; width: 99%; margin-bottom: 4px; box-shadow: 0 1px 8px #f5e0b888; font-size:0.95em;}
    thead th { background: var(--accentColor); font-size:0.98em; letter-spacing:1.1px;}
    tbody tr { height: 34px;}
    td { font-size: 0.99em; padding: 7px 7px 6px 7px; text-align: center; background: #fffbe6;}
    td.table-no {
      background: #f8e8cc; color: #6b4700; font-weight: bold; border-left: 4px solid #e6cb98; border-right: 1.7px solid #edcd90;
      border-radius: 11px 0 0 11px; width: 56px; letter-spacing: 1.2px; font-size: 1em;
    }
    td.cap-cell {
      background: #fdf0d7; font-size: 0.97em; color: #ad7713; font-weight: bold;
    }
    td.empty {
      background: #f8efe2; color: #aeaeae; border: 1.1px dashed #efe1ca; font-style: italic;
    }
    td.reserved {
      background: #fff0da; color: #a65c06; font-weight: bold; border: 2.5px solid #fcb869; box-shadow: 0 1px 3px #fcb86955; letter-spacing: 1px;
    }
    td.phone { font-size: 0.94em; color: #346578; font-weight: 600; letter-spacing: 0.4px;}
    td.num { font-size: 1.02em; font-weight:600; color:#6845ad;}
    td.childnum { font-size: 1em; font-weight:600; color:#0061a6;}
    td.note-cell { max-width:170px; font-size:0.99em; color:#a15e10;}
    td.action-cell { background: transparent; border: none;}
    .act-btn {
      font-size:0.96em; border-radius:8px; border:none;
      margin: 0 3px; padding:1.5px 14px;
      background:var(--btnColor2);
      color:#7c4a01; font-weight:550; cursor:pointer;
      transition: background 0.14s;
    }
    .act-btn:hover { background: var(--dangerColor); color:#fff;}
    .edit-form { background:#fffbe8; padding:12px 14px; border-radius:12px; box-shadow: 0 1px 7px #f5e0b878;}
    .edit-form label, .edit-form input, .edit-form select, .edit-form textarea { font-size:1.08em;}
    .edit-form input[type="number"] { width:60px;}
    .edit-form input[type="text"], .edit-form input[type="tel"] { width:120px;}
    .edit-form textarea { width:160px;}
    @media (max-width: 690px) {
      .big-form{font-size:1.09em;padding:13px 2vw 10px 2vw;}
      .big-form label{font-size:1.07em;}
    }
    @media (max-width: 500px) {
      h1{font-size:1.22em; padding:18px 0 7px 0;}
      .big-form{font-size:1em;padding:8px 0 3px 0;}
      .big-form label, .big-form input, .big-form select, .big-form textarea{font-size:1em;}
      .table-label, .cap-text{font-size:0.95em;}
      #listArea{padding:7px 1vw 15px 1vw;}
      table{font-size:0.88em;}
      .act-btn, button{font-size:1em;padding:8px 18px;}
    }
  </style>
</head>
<body>
<h1>カフェ予約登録</h1>
<form class="big-form" id="resForm" autocomplete="off">
  <label>
    日付:
    <input type="date" id="date" required>
  </label>
  <label>
    大人人数:
    <input type="number" id="numAdult" required min="0" max="10" value="1">
  </label>
  <label>
    子ども人数:
    <input type="number" id="numChild" required min="0" max="10" value="0">
  </label>
  <label style="flex-basis:100%;margin-bottom:5px;">
    テーブル番号（複数選択可）:
    <div class="table-choice" id="tableChoice">
      <!-- JSで生成 -->
    </div>
  </label>
  <label style="flex-basis:98%;">
    時間帯:
    <div class="time-choices" id="timeChoices">
      <!-- JSで生成 -->
    </div>
    <input type="hidden" id="time" required>
  </label>
  <label>
    名前（カタカナ）:
    <input type="text" id="name" pattern="^[ァ-ヴー]+$" required placeholder="例：カトウ">
  </label>
  <label>
    電話番号:
    <input type="tel" id="tel" pattern="^[0-9]+$" required placeholder="例：09012345678">
  </label>
  <div style="width:100%;margin-top:20px;">
    <strong style="font-size:1.12em;color:#906029;">備考：</strong>
    <div class="checkboxes">
      <label><input type="checkbox" id="childPlate" value="お子様プレート">お子様プレート</label>
      <label><input type="checkbox" id="bdayPlate" value="誕生日プレート">誕生日プレート</label>
    </div>
    <div class="detail-notebox">
      <label>
        その他（自由記入）:
        <textarea id="note" placeholder="ご要望など自由記入"></textarea>
      </label>
    </div>
  </div>
  <button type="submit">予約登録</button>
</form>

<h2>予約一覧</h2>
<section id="listArea"></section>

<script>
  // テーブルキャパ定義
  const TABLE_CAPACITY = {
    "T1": 4, "T2": 4,
    "T4": 2, "T5": 2, "T6": 2, "T7": 2, "T8": 2, "T9": 2, "T10": 2
  };
  const TABLES = Object.keys(TABLE_CAPACITY);

  const TIMES = [
    { key: "11:00", label: "11時～"},
    { key: "13:00", label: "13時～"},
    { key: "dinner", label: "ディナー" }
  ];

  function getReservations() {
    return JSON.parse(localStorage.getItem("reservations_v5") || "[]");
  }
  function saveReservations(list) {
    localStorage.setItem("reservations_v5", JSON.stringify(list));
  }

  // テーブル複数選択欄生成
  function renderTableChoices(selected=[]) {
    const tc = document.getElementById("tableChoice");
    tc.innerHTML = "";
    TABLES.forEach(tNo => {
      const span = document.createElement("span");
      span.className = "table-label";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "table-checkbox";
      cb.name = "tableNo";
      cb.value = tNo;
      cb.id = "tb-"+tNo;
      if (selected.includes(tNo)) cb.checked = true;
      const label = document.createElement("label");
      label.htmlFor = "tb-"+tNo;
      label.textContent = tNo;
      const cap = document.createElement("span");
      cap.className = "cap-text";
      cap.textContent = TABLE_CAPACITY[tNo]+"人";
      label.appendChild(cap);
      span.appendChild(cb);
      span.appendChild(label);
      tc.appendChild(span);
    });
  }
  // 時間帯ボタンダウン化
  function renderTimeChoices(selectedKey="") {
    const tc = document.getElementById("timeChoices");
    tc.innerHTML = "";
    TIMES.forEach(t=>{
      const span = document.createElement("span");
      span.className = "time-radio";
      if (t.key === selectedKey) span.classList.add("selected");
      span.innerHTML = `<input type="radio" name="reserveTime" value="${t.key}" style="display:none;">${t.label}`;
      span.onclick = ()=>{
        // 単一選択
        document.getElementById("time").value = t.key;
        renderTimeChoices(t.key);
      };
      tc.appendChild(span);
    });
    document.getElementById("time").value = selectedKey;
  }

  // 予約表画面描画
  function renderList(selectedDate) {
    const area = document.getElementById("listArea");
    area.innerHTML = "";

    const res = getReservations().filter(r=>!selectedDate||r.date===selectedDate);
    if (res.length === 0) {
      area.innerHTML = "<div style='color:#aaa;padding:14px;'>予約はありません</div>";
      return;
    }
    // grouped[date][time][tableNo]
    const grouped = {};
    res.forEach((r, idx) => {
      r.tables.forEach(tableNo => {
        if (!grouped[r.date]) grouped[r.date] = {};
        if (!grouped[r.date][r.time]) grouped[r.date][r.time] = {};
        grouped[r.date][r.time][tableNo] = {
          name: r.name,
          tel: r.tel,
          numAdult: r.numAdult,
          numChild: r.numChild,
          childPlate: r.childPlate,
          bdayPlate: r.bdayPlate,
          note: r.note,
          idx, //予約配列上のindex保存
          tables: r.tables
        };
      });
    });
    const dates = Object.keys(grouped).sort().filter(date=>!selectedDate||date===selectedDate);
    dates.forEach(date => {
      const dateTitle = document.createElement("div");
      dateTitle.className = "date-title";
      dateTitle.textContent = date;
      area.appendChild(dateTitle);

      TIMES.forEach(({key: timeKey, label}) => {
        const title = document.createElement("div");
        title.className = "group-title";
        title.textContent = "■"+label;
        area.appendChild(title);

        // 表
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML =
          "<tr>" +
            "<th>テーブル</th>" +
            "<th>キャパ</th>" +
            "<th>大人</th>" +
            "<th>子ども</th>" +
            "<th>名前</th>" +
            "<th>電話番号</th>" +
            "<th>備考</th>" +
            "<th>操作</th>" +
          "</tr>";
        table.appendChild(thead);
        const tbody = document.createElement("tbody");

        TABLES.forEach(tNo => {
          const tr = document.createElement("tr");
          const tdNo = document.createElement("td");
          tdNo.className = "table-no";
          tdNo.textContent = tNo;
          tr.appendChild(tdNo);

          const tdCap = document.createElement("td");
          tdCap.className = "cap-cell";
          tdCap.textContent = TABLE_CAPACITY[tNo] + "人";
          tr.appendChild(tdCap);

          if (grouped[date][timeKey] && grouped[date][timeKey][tNo]) {
            const info = grouped[date][timeKey][tNo];
            const tdNumA = document.createElement("td");
            tdNumA.className = "num";
            tdNumA.textContent = info.numAdult;
            tr.appendChild(tdNumA);
            const tdNumC = document.createElement("td");
            tdNumC.className = "childnum";
            tdNumC.textContent = info.numChild;
            tr.appendChild(tdNumC);
            const tdName = document.createElement("td");
            tdName.className = "reserved";
            tdName.textContent = info.name;
            tr.appendChild(tdName);
            const tdTel = document.createElement("td");
            tdTel.className = "phone";
            tdTel.textContent = info.tel;
            tr.appendChild(tdTel);

            // 備考
            const tdNote = document.createElement("td");
            tdNote.className = "note-cell";
            let noteStr = [];
            if (info.childPlate) noteStr.push("お子様プレート");
            if (info.bdayPlate) noteStr.push("誕生日プレート");
            if (info.note && info.note.trim() !== "") noteStr.push(info.note.trim());
            tdNote.textContent = noteStr.join("／");
            tr.appendChild(tdNote);

            // 操作欄
            const tdAct = document.createElement("td");
            tdAct.className = "action-cell";
            const removeBtn = document.createElement("button");
            removeBtn.className = "act-btn";
            removeBtn.textContent = "削除";
            removeBtn.onclick = ()=>{
              // 予約データから該当テーブル削除
              const all = getReservations();
              const recIdx = info.idx;
              if (all[recIdx].tables.length === 1) {
                all.splice(recIdx, 1);
              } else {
                all[recIdx].tables = all[recIdx].tables.filter(x=>x!==tNo);
              }
              saveReservations(all);
              renderList(selectedDate);
            };
            // 編集ボタン
            const editBtn = document.createElement("button");
            editBtn.className = "act-btn";
            editBtn.textContent = "変更";
            editBtn.onclick = ()=>{
              showEditForm(info, date, timeKey, tNo, selectedDate);
            };
            tdAct.appendChild(removeBtn);
            tdAct.appendChild(editBtn);
            tr.appendChild(tdAct);
          } else {
            Array(6).fill(0).forEach(()=> {
              const td = document.createElement("td");
              td.className = "empty";
              td.textContent = '';
              tr.appendChild(td);
            });
          }
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        area.appendChild(table);
      });
    });
  }

  // 編集フォーム表示
  function showEditForm(info, date, timeKey, tNo, selectedDate){
    const area = document.getElementById("listArea");
    area.innerHTML = "";
    const editDiv = document.createElement("div");
    editDiv.className = "edit-form";
    editDiv.innerHTML = `
      <h3 style="margin:5px 0 13px 7px;">予約内容の変更（${date} ${tNo} ${timeKey}）</h3>
      <label>大人人数：
        <input type="number" id="editNumA" value="${info.numAdult}" min="0" max="10" required>
      </label>
      <label>子ども人数：
        <input type="number" id="editNumC" value="${info.numChild}" min="0" max="10" required>
      </label>
      <label>名前（カタカナ）：
        <input type="text" id="editName" value="${info.name}" pattern="^[ァ-ヴー]+$" required>
      </label>
      <label>電話番号：
        <input type="tel" id="editTel" value="${info.tel}" pattern="^[0-9]+$" required>
      </label>
      <label style="margin-top:12px;">
        備考：
        <span>
          <input type="checkbox" id="editChildPlate" ${info.childPlate?"checked":""}>お子様プレート
        </span>
        <span>
          <input type="checkbox" id="editBdayPlate" ${info.bdayPlate?"checked":""}>誕生日プレート
        </span>
      </label>
      <label>その他（自由記入）:
        <textarea id="editNote">${info.note||""}</textarea>
      </label>
      <br />
      <button class="act-btn" id="saveEditBtn">変更を保存</button>
      <button class="act-btn" id="cancelEditBtn">キャンセル</button>
    `;
    area.appendChild(editDiv);
    document.getElementById("saveEditBtn").onclick = ()=>{
      const editNumA = document.getElementById("editNumA").value.trim();
      const editNumC = document.getElementById("editNumC").value.trim();
      const editName = document.getElementById("editName").value.trim();
      const editTel = document.getElementById("editTel").value.trim();
      const editChildPlate = document.getElementById("editChildPlate").checked;
      const editBdayPlate = document.getElementById("editBdayPlate").checked;
      const editNote = document.getElementById("editNote").value.trim();
      if (editNumA === "" || editNumC === "" || !editName || !editTel) { alert("全て入力してください"); return;}
      if (!(/^[ァ-ヴー]+$/.test(editName))) { alert("名前はカタカナで入力"); return; }
      if (!(/^[0-9]+$/.test(editTel))) { alert("電話番号は数字のみ"); return;}
      // 編集保存
      const all = getReservations();
      const recIdx = info.idx;
      all[recIdx].numAdult = editNumA;
      all[recIdx].numChild = editNumC;
      all[recIdx].name = editName;
      all[recIdx].tel = editTel;
      all[recIdx].childPlate = editChildPlate;
      all[recIdx].bdayPlate = editBdayPlate;
      all[recIdx].note = editNote;
      saveReservations(all);
      renderList(selectedDate);
    };
    document.getElementById("cancelEditBtn").onclick = ()=> renderList(selectedDate);
  }

  // 登録
  document.getElementById("resForm").onsubmit = function(e) {
    e.preventDefault();
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;
    const numAdult = document.getElementById("numAdult").value.trim();
    const numChild = document.getElementById("numChild").value.trim();
    const name = document.getElementById("name").value.trim();
    const tel = document.getElementById("tel").value.trim();
    const childPlate = document.getElementById("childPlate").checked;
    const bdayPlate = document.getElementById("bdayPlate").checked;
    const note = document.getElementById("note").value.trim();

    // テーブル複数選択
    const tables = [];
    document.querySelectorAll("input[name=tableNo]:checked").forEach(cb => tables.push(cb.value));
    if (!date || !time || numAdult==="" || numChild==="" || !name || !tel) {
      alert("全ての項目を入力してください");
      return;
    }
    if (!(/^[ァ-ヴー]+$/.test(name))) {
      alert("名前はカタカナで入力してください");
      return;
    }
    if (!(/^[0-9]+$/.test(tel))) {
      alert("電話番号は数字のみで入力してください");
      return;
    }
    if (tables.length === 0) {
      alert("テーブル番号を選択してください");
      return;
    }
    // 重複チェック
    const reservations = getReservations();
    for (const t of tables) {
      const already = reservations.find(r =>
        r.date === date && r.time === time && r.tables.includes(t)
      );
      if (already) {
        alert(`${t} は既に予約されています`);
        return;
      }
    }
    reservations.push({ date, time, numAdult, numChild, tables, name, tel, childPlate, bdayPlate, note });
    saveReservations(reservations);
    renderList(date); // 選択日で絞り
    document.getElementById("resForm").reset();
    document.getElementById("time").value = "";
    renderTableChoices();
    renderTimeChoices();
  };

  // 日付選択時、予約一覧も絞り込み
  document.getElementById("date").addEventListener("change", function(e){
    const selDate = e.target.value;
    renderList(selDate);
  });

  // 初期描画
  renderTableChoices();
  renderTimeChoices();
  renderList();

</script>
</body>
</html>
