<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>清水の森 - カフェ予約管理</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&family=Montserrat:wght@500;700;800;900&display=swap" rel="stylesheet">
  <!-- External stylesheet -->
  <link rel="stylesheet" href="styles.css?v=1.3">
  <!-- Firebase setup (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="container">
    <!-- header: title + calendar edit button on the right -->
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h1 style="margin:0">清水の森</h1>
      <div>
        <button id="calendarEditBtn" class="act-btn" style="padding:6px 10px;">カレンダー編集</button>
      </div>
    </div>

    <form id="resForm">
      <label>
        日付:
        <input type="date" id="date" required>
      </label>
      <label>
        大人人数:
        <input type="number" id="numAdult" required min="0" max="10" value="1">
      </label>
      <label>
        子ども人数:
        <input type="number" id="numChild" required min="0" max="10" value="0">
      </label>
      <label style="grid-column: 1/-1;">
        テーブル番号（複数選択可）:
        <div class="table-choice" id="tableChoice"></div>
      </label>
      <label style="grid-column: 1/-1;">
        時間帯:
        <div class="time-choices" id="timeChoices" aria-label="時間帯選択"></div>
        <input type="hidden" id="time" required>
      </label>

      <!-- ここからディナー専用オプション（初期は非表示） -->
      <div id="dinnerOptions" style="display:none; grid-column: 1/-1;">
        <fieldset style="border-radius:10px;padding:10px;background:#fff7ea;border:1px solid #efdfc0;">
          <legend style="font-weight:700;color:#6b4423">ディナーコース選択</legend>

          <label style="margin-bottom:8px;">
            コース選択:
            <select id="dinnerCourse">
              <option value="">（コースなし）</option>
              <option value="洋3000">洋3000円</option>
              <option value="洋4000">洋4000円</option>
              <option value="洋5000">洋5000円</option>
              <option value="和3000">和3000円</option>
              <option value="和4000">和4000円</option>
              <option value="和5000">和5000円</option>
            </select>
          </label>

          <div style="display:flex;align-items:center;gap:12px;">
            <div style="flex:1">
              <div style="font-weight:600;color:#6b4423">2000円（中学生以下のみ）</div>
              <div style="font-size:0.9em;color:#6b4423">※該当人数分を選択してください</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
              <button type="button" id="extraMinus" class="act-btn" style="padding:6px 10px;">−</button>
              <div id="extraCount" style="min-width:36px;text-align:center;font-weight:700">0</div>
              <button type="button" id="extraPlus" class="act-btn" style="padding:6px 10px;">＋</button>
            </div>
          </div>
        </fieldset>
      </div>
      <!-- ディナー専用オプション ここまで -->

      <label>
        名前（カタカナのみ）:
        <input type="text" id="name" pattern="^[ァ-ヴー]+$" placeholder="例：カトウ">
      </label>
      <label>
        電話番号:
        <input type="tel" id="tel" pattern="^[0-9]+$" placeholder="例：09012345678">
      </label>
        <!-- 備考部分（横並び ± 表示） -->
      <label style="grid-column: 1/-1;">
        備考：
        <div id="extrasSection" class="extras-section">
          <div class="extras-row">
            <label class="extras-label">お子様プレート（パスタ） ¥650</label>
            <div class="extras-control" data-type="count" data-key="childPasta">
              <button type="button" class="qty-btn" data-action="decrease" data-target="childPasta">−</button>
              <div class="count-display" id="childPastaDisplay">0</div>
              <button type="button" class="qty-btn" data-action="increase" data-target="childPasta">＋</button>
              <input type="hidden" id="childPastaValue" name="childPastaCount" value="0" />
            </div>
          </div>

          <div class="extras-row">
            <label class="extras-label">お子様プレート（ハンバーグ） ¥650</label>
            <div class="extras-control" data-type="count" data-key="childHamburger">
              <button type="button" class="qty-btn" data-action="decrease" data-target="childHamburger">−</button>
              <div class="count-display" id="childHamburgerDisplay">0</div>
              <button type="button" class="qty-btn" data-action="increase" data-target="childHamburger">＋</button>
              <input type="hidden" id="childHamburgerValue" name="childHamburgerCount" value="0" />
            </div>
          </div>

          <div class="extras-row">
            <label class="extras-label">誕生日プレート ¥1,300</label>
            <div class="extras-control" data-type="count" data-key="birthday">
              <button type="button" class="qty-btn" data-action="decrease" data-target="birthday">−</button>
              <div class="count-display" id="birthdayDisplay">0</div>
              <button type="button" class="qty-btn" data-action="increase" data-target="birthday">＋</button>
              <input type="hidden" id="birthdayValue" name="birthdayCount" value="0" />
            </div>
          </div>

          <div class="extras-row">
            <label class="extras-label">舟盛り（¥10000から）</label>
            <div class="extras-control" data-type="count" data-key="funamori">
              <button type="button" class="qty-btn" data-action="decrease" data-target="funamori">−</button>
              <div class="count-display" id="funamoriDisplay">0</div>
              <button type="button" class="qty-btn" data-action="increase" data-target="funamori">＋</button>
              <input type="hidden" id="funamoriValue" name="funamoriCount" value="0" />
            </div>
          </div>

          <div id="extrasPricePreview" class="extras-price-preview"></div>
        </div>
        <textarea id="note" placeholder="ご要望など自由記入"></textarea>
      </label>
      <button type="submit">予約登録</button>
    </form>

    <h2>予約一覧</h2>
    <div class="scroll-table"><section id="listArea"></section></div>
  </div>

<script>
  // Firebase config (same as existing)
  const firebaseConfig = {
    apiKey: "AIzaSyCIjAeYqS2Bbw60qU6ZUn2q04TlMFD5fdg",
    authDomain: "website-create-shimizunomori.firebaseapp.com",
    projectId: "website-create-shimizunomori",
    storageBucket: "website-create-shimizunomori.appspot.com",
    messagingSenderId: "356236905700",
    appId: "1:356236905700:web:fdae74bcebb1e29856b0f1",
    measurementId: "G-69W2528VVT"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const RES_COLLECTION = "shimizu_cafe_reservations";

  // closed dates set (臨時休業日の読み込み結果を保持)
  let closedDatesSet = new Set();

  // allowDinnerOnSelectedDate: controls whether "dinner" time appears in time choices and in reservation list
  let allowDinnerOnSelectedDate = false;

  // --- 認証チェック（既存） ---
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      renderTableChoices();
      // initial: no date selected -> dinner not allowed
      allowDinnerOnSelectedDate = false;
      renderTimeChoices(allowDinnerOnSelectedDate);
      renderList();
      // load臨時休業日（Firestore の closed_dates コレクション）
      loadClosedDates();
    } else {
      window.location.href = 'login.html';
    }
  });

  // load閉店日（onSnapshot で監視）
  function loadClosedDates() {
    closedDatesSet = new Set();
    db.collection('closed_dates').onSnapshot(snapshot => {
      closedDatesSet.clear();
      snapshot.docs.forEach(d => {
        const data = d.data();
        if (data && data.date) closedDatesSet.add(data.date); // date as 'YYYY-MM-DD'
      });
    }, err => {
      console.error('loadClosedDates failed', err);
    });
  }

  // isDefaultClosed: 日曜日 / 第2・第4月曜日 を判定（Date オブジェクト入力）
  function isDefaultClosed(dateObj) {
    if (!dateObj || !(dateObj instanceof Date)) return false;
    const day = dateObj.getDay(); // 0=Sun,1=Mon...
    if (day === 0) return true; // every Sunday closed

    if (day === 1) { // Monday -> check 2nd or 4th occurrence in month
      const year = dateObj.getFullYear();
      const month = dateObj.getMonth();
      let mondayCount = 0;
      for (let d = 1; d <= dateObj.getDate(); d++) {
        const dt = new Date(year, month, d);
        if (dt.getDay() === 1) mondayCount++;
      }
      if (mondayCount === 2 || mondayCount === 4) return true;
    }
    return false;
  }

  // isDateClosed(YYYY-MM-DD) -> boolean
  function isDateClosed(ymd) {
    if (!ymd) return false;
    const dateObj = new Date(ymd + 'T00:00:00');
    if (isDefaultClosed(dateObj)) return true;
    if (closedDatesSet.has(ymd)) return true;
    return false;
  }

  // helper: check if date (YYYY-MM-DD) is Friday or Saturday
  function isFriOrSat(ymd) {
    if (!ymd) return false;
    const d = new Date(ymd + 'T00:00:00');
    if (isNaN(d)) return false;
    const day = d.getDay(); // 5 = Fri, 6 = Sat
    return (day === 5 || day === 6);
  }

  // top-right カレンダー編集ボタン遷移
  document.getElementById('calendarEditBtn').addEventListener('click', () => {
    window.location.href = 'calendar.html';
  });

  const TABLE_CAPACITY = {"T1":4,"T2":4,"T4":2,"T5":2,"T6":2,"T7":2,"T8":2,"T9":2,"T10":2};
  const TABLES = Object.keys(TABLE_CAPACITY);
  const TIMES = [
    { key: "11:00", label: "11時～"},
    { key: "13:00", label: "13時～"},
    { key: "dinner", label: "ディナー" }
  ];

  // テーブル選択描画
  function renderTableChoices(selected=[]) {
    const tc = document.getElementById("tableChoice");
    tc.innerHTML = "";
    TABLES.forEach(tNo => {
      const span = document.createElement("span");
      span.className = "table-label";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "table-checkbox";
      cb.name = "tableNo";
      cb.value = tNo;
      cb.id = "tb-"+tNo;
      if (selected.includes(tNo)) cb.checked = true;
      const label = document.createElement("label");
      label.htmlFor = "tb-"+tNo;
      label.textContent = tNo;
      const cap = document.createElement("span");
      cap.className = "cap-text";
      cap.textContent = TABLE_CAPACITY[tNo]+"人";
      label.appendChild(cap);
      span.appendChild(cb);
      span.appendChild(label);
      tc.appendChild(span);
    });
  }

  // 時間帯ボタン描画（allowDinner を渡してディナーを表示するか制御）
  let selectedTime = "";
  function renderTimeChoices(allowDinner = true, initKey="") {
    const tc = document.getElementById("timeChoices");
    if (!tc) return;
    tc.innerHTML = "";

    // Determine which TIMES to render based on allowDinner
    const timesToRender = TIMES.filter(t => {
      if (t.key === 'dinner' && !allowDinner) return false;
      return true;
    });

    if (initKey && timesToRender.some(x => x.key === initKey)) {
      selectedTime = initKey;
      const hidden = document.getElementById("time");
      if (hidden) hidden.value = initKey;
    } else {
      // if initKey not allowed, ensure selectedTime is not 'dinner'
      if (!allowDinner && selectedTime === 'dinner') {
        selectedTime = "";
        const hidden = document.getElementById("time");
        if (hidden) hidden.value = "";
      }
    }

    timesToRender.forEach(t => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "time-radio";
      btn.setAttribute("data-time", t.key);
      btn.textContent = t.label;
      if (t.key === selectedTime) btn.classList.add("selected");

      btn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        const prev = tc.querySelector(".time-radio.selected");
        if (prev && prev !== btn) prev.classList.remove("selected");
        btn.classList.add("selected");
        selectedTime = t.key;
        const hidden = document.getElementById("time");
        if (hidden) hidden.value = t.key;
        updateDinnerOptionsVisibility();
      });

      tc.appendChild(btn);
    });

    // reflect initial visibility for dinner options
    updateDinnerOptionsVisibility();
  }

  // ディナーオプションの表示・活性化制御（selectedTime が dinner の時のみ表示）
  function updateDinnerOptionsVisibility() {
    const container = document.getElementById("dinnerOptions");
    const select = document.getElementById("dinnerCourse");
    const extraCountEl = document.getElementById("extraCount");
    const plus = document.getElementById("extraPlus");
    const minus = document.getElementById("extraMinus");
    if (!container) return;
    // Show dinner options only if dinner is selected AND dinner is allowed on selected date
    if (selectedTime === 'dinner' && allowDinnerOnSelectedDate) {
      container.style.display = 'block';
      if (select) select.disabled = false;
      if (plus) plus.disabled = false;
      if (minus) minus.disabled = false;
    } else {
      container.style.display = 'none';
      if (select) { select.value = ""; select.disabled = true; }
      if (extraCountEl) extraCountEl.textContent = '0';
      if (plus) plus.disabled = true;
      if (minus) minus.disabled = true;
    }
  }

  // extra +/- handlers
  document.addEventListener('click', function(e){
    if (e.target && e.target.id === 'extraPlus') {
      const el = document.getElementById('extraCount');
      let v = parseInt(el.textContent || '0', 10);
      el.textContent = String(v + 1);
    } else if (e.target && e.target.id === 'extraMinus') {
      const el = document.getElementById('extraCount');
      let v = parseInt(el.textContent || '0', 10);
      if (v > 0) el.textContent = String(v - 1);
    }
  });

  // 日付選択で一覧も絞り込み（休業日チェック + 金/土以外はディナー非表示）
  let selectedDateVal = "";
  document.getElementById("date").addEventListener("change", function(e){
    const chosen = e.target.value;
    if (!chosen) {
      selectedDateVal = "";
      allowDinnerOnSelectedDate = false;
      renderTimeChoices(allowDinnerOnSelectedDate);
      renderList('');
      return;
    }
    // block Sundays, 2nd/4th Mondays, and closedDates
    if (isDateClosed(chosen)) {
      alert("選択した日は休業日のため予約できません。");
      e.target.value = ""; // reset selection
      selectedDateVal = "";
      allowDinnerOnSelectedDate = false;
      renderTimeChoices(allowDinnerOnSelectedDate);
      renderList('');
      return;
    }

    // determine if dinner allowed for this date (only Fri or Sat)
    allowDinnerOnSelectedDate = isFriOrSat(chosen);

    // If dinner not allowed and currently selected time is dinner, clear selection
    if (!allowDinnerOnSelectedDate && selectedTime === 'dinner') {
      selectedTime = "";
      const hidden = document.getElementById("time");
      if (hidden) hidden.value = "";
    }

    // re-render time choices with dinner visibility according to allowDinnerOnSelectedDate
    renderTimeChoices(allowDinnerOnSelectedDate);

    selectedDateVal = chosen;
    renderList(selectedDateVal);
  });

  // 予約登録（with table capacity check）
  document.getElementById("resForm").onsubmit = async function(e) {
    e.preventDefault();
  
    const date = document.getElementById("date")?.value || "";
    const time = document.getElementById("time")?.value || "";
    const numAdultRaw = document.getElementById("numAdult")?.value;
    const numChildRaw = document.getElementById("numChild")?.value;
    const numAdult = Number(numAdultRaw || 0);
    const numChild = Number(numChildRaw || 0);
    const name = document.getElementById("name")?.value.trim() || "";
    const tel = document.getElementById("tel")?.value.trim() || "";
    const note = document.getElementById("note")?.value.trim() || "";
  
    // collect selected tables
    const tables = [];
    document.querySelectorAll("input[name=tableNo]:checked").forEach(cb => tables.push(cb.value));
  
    // ディナー追加データ
    const course = document.getElementById("dinnerCourse") ? document.getElementById("dinnerCourse").value || null : null;
    const extraUnder15 = document.getElementById("extraCount") ? parseInt(document.getElementById("extraCount").textContent || '0', 10) : 0;
  
    // 必須項目チェック
    if (!date || !time || isNaN(numAdult) || isNaN(numChild)) {
      alert("日付・時間・人数は必須です");
      return;
    }
    if (name && !(/^[ァ-ヴー]+$/.test(name))) {
      alert("名前はカタカナのみで入力してください");
      return;
    }
    if (tel && !(/^[0-9]+$/.test(tel))) {
      alert("電話番号は数字のみで入力してください");
      return;
    }
    if (tables.length === 0) {
      alert("テーブル番号を選択してください");
      return;
    }

    // New: disallow booking on closed date just before saving (defensive)
    if (isDateClosed(date)) {
      alert("選択した日は休業日のため予約できません。");
      return;
    }

    // If time is dinner but dinner is not allowed on the selected date, block it
    if (time === 'dinner' && !allowDinnerOnSelectedDate) {
      alert("選択された日付ではディナーは受け付けていません。");
      return;
    }
  
    // 選択テーブル合計キャパチェック
    const totalPeople = numAdult + numChild;
    const totalCap = tables.reduce((sum, t) => sum + (Number(TABLE_CAPACITY[t] || 0)), 0);
    if (totalPeople > totalCap) {
      alert("予約人数がテーブル人数のキャパを超えています。");
      return;
    }
  
    // 重複チェック
    try {
      const snapshot = await db.collection(RES_COLLECTION)
        .where("date", "==", date).where("time", "==", time)
        .get();
      const overlap = snapshot.docs.some(doc => {
        const r = doc.data();
        return (r.tables||[]).some(t=>tables.includes(t));
      });
      if (overlap) {
        alert("選択したテーブルで既に予約があります");
        return;
      }
    } catch (err) {
      console.error('Overlap check failed', err);
      alert('予約の重複チェックに失敗しました: ' + (err.message || err));
      return;
    }
  
    // 保存（extras をマージ）
    try {
      const extras = (typeof getExtrasForSave === 'function') ? getExtrasForSave() : {};
      await db.collection(RES_COLLECTION).add(Object.assign({
        date, time, numAdult, numChild, tables, name, tel, note,
        course: course || null,
        extraUnder15: extraUnder15 || 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, extras));
    } catch (err) {
      console.error('Firestore add error', err);
      alert('予約登録に失敗しました: ' + (err.message || err));
      return;
    }
  
    // reset
    document.getElementById("resForm").reset();
    document.getElementById("time").value = "";
    selectedTime = "";
    allowDinnerOnSelectedDate = false;
    updateDinnerOptionsVisibility();
    document.getElementById("extraCount").textContent = '0';
    if (typeof populateExtrasFromDoc === 'function') populateExtrasFromDoc({});
    renderTableChoices();
    renderTimeChoices(allowDinnerOnSelectedDate);
    selectedDateVal = date;
    renderList(selectedDateVal);
  };

  // --- renderList / drawTable / showEditForm / extras handlers ---

  let unsubscribe = null;
  function renderList(selectedDate) {
    const area = document.getElementById("listArea");
    area.innerHTML = "";

    if (!selectedDate) {
      if (typeof unsubscribe === 'function') {
        try { unsubscribe(); } catch(e){ /* ignore */ }
        unsubscribe = null;
      }
      area.innerHTML = '<div style="color:#666;padding:18px;font-size:1rem;">日付を選択してください（カレンダーで日付を選ぶと、その日の予約が表示されます）</div>';
      return;
    }

    area.innerHTML = "<div style='color:#aaa;padding:14px;'>読込中...</div>";
    if (unsubscribe) unsubscribe();
    unsubscribe = db.collection(RES_COLLECTION)
      .orderBy("date").orderBy("time").orderBy("createdAt")
      .onSnapshot((querySnap)=>{
        const docs = querySnap.docs.map((d,i)=>({...d.data(), _id: d.id, index:i}));
        const filtered = selectedDate ? docs.filter(r=>r.date===selectedDate) : [];
        drawTable(filtered, selectedDate);
      }, err => {
        console.error('onSnapshot error', err);
        area.innerHTML = "<div style='color:#a00;padding:14px;'>データの読み込みに失敗しました: "+(err.message||err)+"</div>";
      });
  }

  function drawTable(res, selectedDate) {
    const area = document.getElementById("listArea");
    area.innerHTML = "";
    if (!res || res.length === 0) {
      area.innerHTML = "<div style='color:#aaa;padding:14px;'>予約はありません</div>";
      return;
    }

    const grouped = {};
    res.forEach((r, idx) => {
      (r.tables || []).forEach(tableNo => {
        if (!grouped[r.date]) grouped[r.date] = {};
        if (!grouped[r.date][r.time]) grouped[r.date][r.time] = {};
        grouped[r.date][r.time][tableNo] = {
          numAdult: r.numAdult, numChild: r.numChild, name: r.name, tel: r.tel,
          childPlate: r.childPlate, bdayPlate: r.bdayPlate, note: r.note,
          course: r.course || null, extraUnder15: r.extraUnder15 || 0,
          childPlatePastaCount: r.childPlatePastaCount || 0,
          childPlateHamburgerCount: r.childPlateHamburgerCount || 0,
          birthdayPlateCount: r.birthdayPlateCount || 0,
          funamoriCount: r.funamoriCount || (r.funamoriAmount ? Math.round((r.funamoriAmount||0)/10000) : 0),
          extrasTotal: r.extrasTotal || 0,
          _id: r._id, index: idx, tables: r.tables
        };
      });
    });

    const dates = Object.keys(grouped).sort().filter(d => !selectedDate || d === selectedDate);
    dates.forEach(date => {
      const dateTitle = document.createElement("div");
      dateTitle.className = "date-title";
      dateTitle.textContent = date;
      area.appendChild(dateTitle);

      // decide which TIMES to show here too (if dinner not allowed, skip dinner group)
      const timesToShow = TIMES.filter(t => {
        if (t.key === 'dinner' && !allowDinnerOnSelectedDate) return false;
        return true;
      });

      timesToShow.forEach(({ key: timeKey, label }) => {
        const title = document.createElement("div");
        title.className = "group-title";
        title.textContent = "■" + label;
        area.appendChild(title);

        const tableWrap = document.createElement("div"); tableWrap.className = "scroll-table";
        const table = document.createElement("table");
        const thead = document.createElement("thead");

        // ヘッダ：ディナーなら「コース」「中学生以下2000円」を含める
        if (timeKey === 'dinner') {
          thead.innerHTML =
            "<tr>" +
              "<th>テーブル</th><th>キャパ</th><th>大人</th><th>子ども</th><th>名前</th><th>電話番号</th><th>コース</th><th>中学生以下2000円</th><th>備考</th><th>操作</th>" +
            "</tr>";
        } else {
          thead.innerHTML =
            "<tr>" +
              "<th>テーブル</th><th>キャパ</th><th>大人</th><th>子ども</th><th>名前</th><th>電話番号</th><th>備考</th><th>操作</th>" +
            "</tr>";
        }

        table.appendChild(thead);
        const tbody = document.createElement("tbody");

        TABLES.forEach((tNo, tIndex) => {
          const tr = document.createElement("tr");

          const tdNo = document.createElement("td");
          tdNo.className = "table-no";
          tdNo.textContent = tNo;
          const hasRes = grouped[date] && grouped[date][timeKey] && grouped[date][timeKey][tNo];
          if (!hasRes) tdNo.classList.add('available');
          tr.appendChild(tdNo);

          const tdCap = document.createElement("td");
          tdCap.className = "cap-cell";
          tdCap.textContent = TABLE_CAPACITY[tNo] + "人";
          tr.appendChild(tdCap);

          if (hasRes) {
            const info = grouped[date][timeKey][tNo];
            const reservationTables = (info.tables || []).filter(x => TABLES.includes(x));
            const orderedResTables = TABLES.filter(t => reservationTables.includes(t));
            const isFirst = orderedResTables.length > 0 && orderedResTables[0] === tNo;
            if (isFirst) {
              const rowspan = Math.max(1, orderedResTables.length);

              const tdNumA = document.createElement("td");
              tdNumA.className = "num merged-cell";
              tdNumA.textContent = info.numAdult;
              tdNumA.rowSpan = rowspan;
              tdNumA.style.verticalAlign = "middle";
              tr.appendChild(tdNumA);

              const tdNumC = document.createElement("td");
              tdNumC.className = "childnum merged-cell";
              tdNumC.textContent = info.numChild;
              tdNumC.rowSpan = rowspan;
              tdNumC.style.verticalAlign = "middle";
              tr.appendChild(tdNumC);

              const tdName = document.createElement("td");
              tdName.className = "reserved merged-cell";
              tdName.textContent = info.name || "";
              tdName.rowSpan = rowspan;
              tdName.style.verticalAlign = "middle";
              tr.appendChild(tdName);

              const tdTel = document.createElement("td");
              tdTel.className = "phone merged-cell";
              tdTel.textContent = info.tel || "";
              tdTel.rowSpan = rowspan;
              tdTel.style.verticalAlign = "middle";
              tr.appendChild(tdTel);

              if (timeKey === 'dinner') {
                const tdCourse = document.createElement("td");
                tdCourse.className = "course-cell merged-cell";
                tdCourse.textContent = info.course || "";
                tdCourse.rowSpan = rowspan;
                tdCourse.style.verticalAlign = "middle";
                tdCourse.style.textAlign = "center";
                tr.appendChild(tdCourse);

                const tdExtra = document.createElement("td");
                tdExtra.className = "extra-cell merged-cell";
                tdExtra.textContent = (info.extraUnder15 && info.extraUnder15 > 0) ? `${info.extraUnder15}名` : "";
                tdExtra.rowSpan = rowspan;
                tdExtra.style.verticalAlign = "middle";
                tdExtra.style.textAlign = "center";
                tr.appendChild(tdExtra);
              }

              const tdNote = document.createElement("td");
              tdNote.className = "note-cell merged-cell";
              let noteStr = [];
              if (info.childPlate) noteStr.push("お子様プレート");
              if (info.bdayPlate) noteStr.push("誕生日プレート");
              if (info.childPlatePastaCount && info.childPlatePastaCount > 0) noteStr.push(`パスタ x${info.childPlatePastaCount}`);
              if (info.childPlateHamburgerCount && info.childPlateHamburgerCount > 0) noteStr.push(`ハンバーグ x${info.childPlateHamburgerCount}`);
              if (info.birthdayPlateCount && info.birthdayPlateCount > 0) noteStr.push(`誕生日プレート x${info.birthdayPlateCount}`);
              if ((info.funamoriCount || 0) > 0) noteStr.push(`舟盛り x${info.funamoriCount}`);
              if (info.note && info.note.trim() !== "") noteStr.push(info.note);
              tdNote.textContent = noteStr.join("／");
              tdNote.rowSpan = rowspan;
              tdNote.style.verticalAlign = "middle";
              tdNote.style.textAlign = "center";
              tr.appendChild(tdNote);

              const tdAct = document.createElement("td");
              tdAct.className = "action-cell merged-cell";
              tdAct.rowSpan = rowspan;
              tdAct.style.verticalAlign = "middle";
              tdAct.style.textAlign = "center";

              const removeBtn = document.createElement("button");
              removeBtn.className = "act-btn";
              removeBtn.textContent = "削除";
              removeBtn.onclick = async () => {
                if (confirm("本当に削除してもよいですか？")) {
                  try {
                    await db.collection(RES_COLLECTION).doc(info._id).delete();
                  } catch (err) {
                    console.error('Delete failed', err);
                    alert('削除に失敗しました: ' + (err.message || err));
                  }
                }
              };

              const editBtn = document.createElement("button");
              editBtn.className = "act-btn";
              editBtn.textContent = "変更";
              editBtn.style.marginLeft = "8px";
              editBtn.onclick = () => { showEditForm(info, date, timeKey, tNo, selectedDate); };

              tdAct.appendChild(removeBtn);
              tdAct.appendChild(editBtn);
              tr.appendChild(tdAct);
            }
          } else {
            Array(6 + (timeKey === 'dinner' ? 2 : 0)).fill(0).forEach(() => {
              const td = document.createElement("td");
              td.className = "empty";
              td.textContent = '';
              tr.appendChild(td);
            });
          }

          const nextTable = TABLES[tIndex + 1];
          if (hasRes && nextTable) {
            const nextInfo = grouped[date] && grouped[date][timeKey] && grouped[date][timeKey][nextTable];
            if (nextInfo && nextInfo._id === grouped[date][timeKey][tNo]._id) {
              tr.classList.add('no-divider');
            }
          }

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        tableWrap.appendChild(table);
        area.appendChild(tableWrap);
      });
    });
  }

  // showEditForm: full implementation with editable extras and table re-selection
  function showEditForm(info, date, timeKey, tNo, selectedDate) {
    const area = document.getElementById("listArea");
    area.innerHTML = "";
    const editDiv = document.createElement("div");
    editDiv.className = "edit-form";

    const courseValue = info.course || "";
    const extraValue = info.extraUnder15 || 0;

    // Build HTML: includes table-choice area and editable extras (edit-prefixed IDs)
    editDiv.innerHTML = `
      <h3 style="margin:7px 0 13px 7px;font-size:1.02em;color:#a77f50">
        変更（${date} ${tNo} ${timeKey}）
      </h3>

      <label>名前：
        <input type="text" id="editName" value="${(info.name||'').replace(/"/g,'&quot;')}" placeholder="例：カトウ">
      </label>

      <label>電話番号：
        <input type="tel" id="editTel" value="${(info.tel||'').replace(/"/g,'&quot;')}" placeholder="例：09012345678">
      </label>

      <label>大人人数：
        <input type="number" id="editNumA" value="${info.numAdult}" min="0" max="10" required>
      </label>
      <label>子ども人数：
        <input type="number" id="editNumC" value="${info.numChild}" min="0" max="10" required>
      </label>

      ${timeKey === 'dinner' ? `
      <label style="margin-top:10px;">コース:
        <select id="editCourse">
          <option value="">（コースなし）</option>
          <option value="洋3000" ${courseValue==='洋3000' ? 'selected' : ''}>洋3000円</option>
          <option value="洋4000" ${courseValue==='洋4000' ? 'selected' : ''}>洋4000円</option>
          <option value="洋5000" ${courseValue==='洋5000' ? 'selected' : ''}>洋5000円</option>
          <option value="和3000" ${courseValue==='和3000' ? 'selected' : ''}>和3000円</option>
          <option value="和4000" ${courseValue==='和4000' ? 'selected' : ''}>和4000円</option>
          <option value="和5000" ${courseValue==='和5000' ? 'selected' : ''}>和5000円</option>
        </select>
      </label>

      <label style="margin-top:8px;">2000円（中学生以下のみ）:
        <div style="display:flex;align-items:center;gap:8px;">
          <button type="button" class="act-btn" id="editExtraMinus">−</button>
          <div id="editExtraCount" style="min-width:36px;text-align:center;font-weight:700">${extraValue}</div>
          <button type="button" class="act-btn" id="editExtraPlus">＋</button>
        </div>
      </label>
      ` : ``}

      <label style="display:block;margin-top:10px;">
        テーブル（選択を変更できます）:
        <div id="editTableChoice" style="margin-top:6px; display:flex; flex-wrap:wrap; gap:8px;"></div>
      </label>

      <fieldset style="border-radius:6px;padding:8px;margin-top:10px;border:1px solid #ddd;">
        <legend style="font-weight:700">備考</legend>

        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;">
          <label style="min-width:150px;">お子様プレート（パスタ） ¥650</label>
          <div style="display:flex;align-items:center;gap:8px;">
            <button type="button" class="act-btn edit-qty-btn" data-action="decrease" data-target="editChildPasta">−</button>
            <div id="editChildPastaDisplay" style="min-width:44px;text-align:center;font-weight:700">0</div>
            <button type="button" class="act-btn edit-qty-btn" data-action="increase" data-target="editChildPasta">＋</button>
            <input type="hidden" id="editChildPastaValue" />
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;">
          <label style="min-width:150px;">お子様プレート（ハンバーグ） ¥650</label>
          <div style="display:flex;align-items:center;gap:8px;">
            <button type="button" class="act-btn edit-qty-btn" data-action="decrease" data-target="editChildHamburger">−</button>
            <div id="editChildHamburgerDisplay" style="min-width:44px;text-align:center;font-weight:700">0</div>
            <button type="button" class="act-btn edit-qty-btn" data-action="increase" data-target="editChildHamburger">＋</button>
            <input type="hidden" id="editChildHamburgerValue" />
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;">
          <label style="min-width:150px;">誕生日プレート ¥1,300</label>
          <div style="display:flex;align-items:center;gap:8px;">
            <button type="button" class="act-btn edit-qty-btn" data-action="decrease" data-target="editBirthday">−</button>
            <div id="editBirthdayDisplay" style="min-width:44px;text-align:center;font-weight:700">0</div>
            <button type="button" class="act-btn edit-qty-btn" data-action="increase" data-target="editBirthday">＋</button>
            <input type="hidden" id="editBirthdayValue" />
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;">
          <label style="min-width:150px;">舟盛り（¥10000から）</label>
          <div style="display:flex;align-items:center;gap:8px;">
            <button type="button" class="act-btn edit-qty-btn" data-action="decrease" data-target="editFunamori">−</button>
            <div id="editFunamoriDisplay" style="min-width:44px;text-align:center;font-weight:700">0</div>
            <button type="button" class="act-btn edit-qty-btn" data-action="increase" data-target="editFunamori">＋</button>
            <input type="hidden" id="editFunamoriValue" />
          </div>
        </div>

      </fieldset>

      <label style="display:block;margin-top:8px;">その他（自由記入）:
        <textarea id="editNote">${(info.note||'').replace(/</g,'&lt;')}</textarea>
      </label>

      <div style="margin-top:10px">
        <button class="act-btn" id="saveEditBtn">保存</button>
        <button class="act-btn" id="cancelEditBtn">キャンセル</button>
      </div>
    `;

    area.appendChild(editDiv);

    // render table checkboxes in edit form
    const editTableChoice = document.getElementById('editTableChoice');
    editTableChoice.innerHTML = "";
    TABLES.forEach(tNo => {
      const span = document.createElement('span');
      span.className = 'table-label';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.className = 'table-checkbox';
      cb.name = 'editTableNo';
      cb.value = tNo;
      cb.id = 'edit-tb-' + tNo;
      if ((info.tables || []).includes(tNo)) cb.checked = true;
      const lab = document.createElement('label');
      lab.htmlFor = 'edit-tb-' + tNo;
      lab.textContent = tNo;
      const cap = document.createElement('span');
      cap.className = 'cap-text';
      cap.textContent = TABLE_CAPACITY[tNo] + '人';
      lab.appendChild(cap);
      span.appendChild(cb);
      span.appendChild(lab);
      editTableChoice.appendChild(span);
    });

    // init edit extra counts (populate from info)
    document.getElementById('editChildPastaValue').value = info.childPlatePastaCount || 0;
    document.getElementById('editChildPastaDisplay').textContent = String(info.childPlatePastaCount || 0);
    document.getElementById('editChildHamburgerValue').value = info.childPlateHamburgerCount || 0;
    document.getElementById('editChildHamburgerDisplay').textContent = String(info.childPlateHamburgerCount || 0);
    document.getElementById('editBirthdayValue').value = info.birthdayPlateCount || 0;
    document.getElementById('editBirthdayDisplay').textContent = String(info.birthdayPlateCount || 0);
    const initialFunamori = Number(info.funamoriCount || 0) || (info.funamoriAmount ? Math.round((info.funamoriAmount||0)/10000) : 0);
    document.getElementById('editFunamoriValue').value = initialFunamori;
    document.getElementById('editFunamoriDisplay').textContent = String(initialFunamori);

    // attach handlers for edit qty buttons
    editDiv.querySelectorAll('.edit-qty-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        const target = btn.dataset.target;
        editHandleCount(action, target);
      });
    });

    // wire editExtra +/- (dinner)
    if (timeKey === 'dinner') {
      const editExtraPlus = document.getElementById('editExtraPlus');
      const editExtraMinus = document.getElementById('editExtraMinus');
      if (editExtraPlus) editExtraPlus.onclick = () => {
        const el = document.getElementById('editExtraCount');
        el.textContent = String(parseInt(el.textContent||'0',10) + 1);
      };
      if (editExtraMinus) editExtraMinus.onclick = () => {
        const el = document.getElementById('editExtraCount');
        const v = parseInt(el.textContent||'0',10);
        if (v > 0) el.textContent = String(v - 1);
      };
    }

    // save / cancel handlers
    document.getElementById('cancelEditBtn').onclick = () => renderList(selectedDate);

    document.getElementById('saveEditBtn').onclick = async () => {
      const editName = document.getElementById("editName")?.value.trim() || "";
      const editTel = document.getElementById("editTel")?.value.trim() || "";
      const editNumA = document.getElementById("editNumA")?.value.trim() || "";
      const editNumC = document.getElementById("editNumC")?.value.trim() || "";
      const editChildPlate = document.getElementById("editChildPlate") ? document.getElementById("editChildPlate").checked : false;
      const editBdayPlate = document.getElementById("editBdayPlate") ? document.getElementById("editBdayPlate").checked : false;
      const editNote = document.getElementById("editNote")?.value.trim() || "";
      const editCourse = (timeKey === 'dinner' && document.getElementById("editCourse")) ? (document.getElementById("editCourse").value || null) : null;
      const editExtra = timeKey === 'dinner' ? parseInt(document.getElementById("editExtraCount")?.textContent||'0',10) : 0;

      if (editNumA === "" || editNumC === "") { alert("人数入力必須です"); return; }
      if (editName && !(/^[ァ-ヴー]+$/.test(editName))) { alert("名前はカタカナのみで入力してください"); return; }
      if (editTel && !(/^[0-9]+$/.test(editTel))) { alert("電話番号は数字のみで入力してください"); return; }

      // collect selected tables
      const tables = [];
      document.querySelectorAll("input[name=editTableNo]:checked").forEach(cb => tables.push(cb.value));
      if (tables.length === 0) { alert("テーブル番号を1つ以上選択してください"); return; }

      // defensive: check closed date if date field present (info.date may exist)
      if (isDateClosed(info.date)) {
        alert("編集対象の日付は休業日です。");
        return;
      }

      // capacity check on edit: use requested numbers
      const totalPeople = (Number(editNumA) || 0) + (Number(editNumC) || 0);
      const totalCap = tables.reduce((sum, t) => sum + (Number(TABLE_CAPACITY[t] || 0)), 0);
      if (totalPeople > totalCap) {
        alert("選択されたテーブルより予約人数が上回っています。テーブルを追加選択してください。");
        return;
      }

      // collect extras
      const eChildPasta = Number(document.getElementById('editChildPastaValue')?.value || 0);
      const eChildHamb = Number(document.getElementById('editChildHamburgerValue')?.value || 0);
      const eBday = Number(document.getElementById('editBirthdayValue')?.value || 0);
      const eFunamori = Number(document.getElementById('editFunamoriValue')?.value || 0);

      try {
        await db.collection(RES_COLLECTION).doc(info._id).update({
          name: editName || null,
          tel: editTel || null,
          numAdult: editNumA,
          numChild: editNumC,
          childPlate: editChildPlate,
          bdayPlate: editBdayPlate,
          note: editNote,
          course: editCourse || null,
          extraUnder15: editExtra || 0,
          tables: tables,
          childPlatePastaCount: eChildPasta,
          childPlateHamburgerCount: eChildHamb,
          birthdayPlateCount: eBday,
          funamoriCount: eFunamori
        });
      } catch (err) {
        console.error('Update failed', err);
        alert('更新に失敗しました: ' + (err.message || err));
        return;
      }

      renderList(selectedDate);
    };

    function editHandleCount(action, editKey) {
      const display = document.getElementById(editKey + 'Display');
      const input = document.getElementById(editKey + 'Value');
      let v = Number(input.value) || 0;
      if (action === 'increase') v++;
      else v = Math.max(0, v - 1);
      input.value = v;
      if (display) display.textContent = String(v);
    }
  }

  // ---------- extras handlers ----------
  const PRICE_CHILD_PLATE = 650;
  const PRICE_BIRTHDAY_PLATE = 1300;

  function initExtrasHandlers() {
    document.querySelectorAll('.extras-control .qty-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const action = btn.dataset.action;
        const target = btn.dataset.target;
        if (action && target) handleCount(action, target);
      });
    });
    updateExtrasPreview();
  }

  function handleCount(action, key) {
    const display = document.getElementById(key + 'Display');
    const input = document.getElementById(key + 'Value');
    let v = Number(input.value) || 0;
    if (action === 'increase') v++;
    else v = Math.max(0, v - 1);
    input.value = v;
    if (display) display.textContent = String(v);
    updateExtrasPreview();
  }

  function updateExtrasPreview() {
    const previewEl = document.getElementById('extrasPricePreview');
    if (previewEl) previewEl.textContent = '';
  }

  function getExtrasForSave() {
    const pasta = Number(document.getElementById('childPastaValue').value) || 0;
    const hamb = Number(document.getElementById('childHamburgerValue').value) || 0;
    const bday = Number(document.getElementById('birthdayValue').value) || 0;
    const funaCount = Number(document.getElementById('funamoriValue').value) || 0;
    return {
      childPlatePastaCount: pasta,
      childPlateHamburgerCount: hamb,
      birthdayPlateCount: bday,
      funamoriCount: funaCount,
      extrasUnitPrices: { childPlateUnit: PRICE_CHILD_PLATE, birthdayPlateUnit: PRICE_BIRTHDAY_PLATE }
    };
  }

  function populateExtrasFromDoc(docData) {
    const d = docData || {};
    document.getElementById('childPastaValue').value = d.childPlatePastaCount || 0;
    document.getElementById('childPastaDisplay').textContent = String(d.childPlatePastaCount || 0);
    document.getElementById('childHamburgerValue').value = d.childPlateHamburgerCount || 0;
    document.getElementById('childHamburgerDisplay').textContent = String(d.childPlateHamburgerCount || 0);
    document.getElementById('birthdayValue').value = d.birthdayPlateCount || 0;
    document.getElementById('birthdayDisplay').textContent = String(d.birthdayPlateCount || 0);
    const funaCount = Number(d.funamoriCount || 0);
    document.getElementById('funamoriValue').value = funaCount;
    document.getElementById('funamoriDisplay').textContent = String(funaCount);
    updateExtrasPreview();
  }

  // page init
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initExtrasHandlers);
  } else {
    initExtrasHandlers();
  }
</script>
</body>
</html>
