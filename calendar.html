<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>清水の森 - カレンダー編集</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css?v=1.3">
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h1 style="margin:0">カレンダー編集</h1>
      <div>
        <button id="backBtn" class="act-btn">予約管理に戻る</button>
      </div>
    </div>

    <p>ここでは臨時休業日を追加・削除できます。<br>
    ※ 毎週日曜・第2・第4月曜はデフォルトで休業扱いになります（編集不要）。</p>

    <label>
      休業日（個別追加）:
      <input type="date" id="closedDate" />
      <button id="addClosedBtn" class="act-btn">追加</button>
    </label>

    <h3>登録済みの臨時休業日</h3>
    <div id="closedList"></div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCIjAeYqS2Bbw60qU6ZUn2q04TlMFD5fdg",
    authDomain: "website-create-shimizunomori.firebaseapp.com",
    projectId: "website-create-shimizunomori",
    storageBucket: "website-create-shimizunomori.appspot.com",
    messagingSenderId: "356236905700",
    appId: "1:356236905700:web:fdae74bcebb1e29856b0f1",
    measurementId: "G-69W2528VVT"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // auth guard
  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }
    // else: load list
    watchClosedDates();
  });

  document.getElementById('backBtn').addEventListener('click', ()=> {
    window.location.href = 'index.html';
  });

  // helper: Japanese weekday label for YYYY-MM-DD
  function weekdayLabelFromYMD(ymd) {
    if (!ymd) return '';
    const d = new Date(ymd + 'T00:00:00');
    if (isNaN(d)) return '';
    const labels = ['日','月','火','水','木','金','土'];
    return labels[d.getDay()];
  }

  document.getElementById('addClosedBtn').addEventListener('click', async () => {
    const inp = document.getElementById('closedDate');
    const val = inp.value;
    if (!val) { alert('日付を選択してください'); return; }

    try {
      // use doc id = YYYY-MM-DD for easy upsert / delete
      await db.collection('closed_dates').doc(val).set({
        date: val,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      inp.value = '';
    } catch (err) {
      console.error('add closed date failed', err);
      const msg = (err && err.code === 'permission-denied')
        ? '臨時休業日の追加に権限がありません。'
        : '追加に失敗しました: ' + (err.message || err);
      alert(msg);
    }
  });

  // list and watch closed_dates (display date with weekday e.g. 2026-01-22(木))
  function watchClosedDates() {
    const list = document.getElementById('closedList');
    list.innerHTML = '<div style="color:#666">読み込み中...</div>';
    db.collection('closed_dates').orderBy('date','desc').onSnapshot(snapshot => {
      list.innerHTML = '';
      if (snapshot.empty) {
        list.innerHTML = '<div style="color:#666">登録された臨時休業日はありません。</div>';
        return;
      }
      snapshot.docs.forEach(doc => {
        const d = doc.data();
        const displayDate = d.date || doc.id;
        const wd = weekdayLabelFromYMD(displayDate);
        const text = wd ? `${displayDate}(${wd})` : displayDate;

        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.padding = '6px 0';

        const left = document.createElement('div');
        left.textContent = text;

        const right = document.createElement('div');
        const del = document.createElement('button');
        del.className = 'act-btn';
        del.textContent = '削除';
        del.addEventListener('click', async () => {
          if (!confirm(`${text} を臨時休業日から削除しますか？`)) return;
          try {
            await db.collection('closed_dates').doc(doc.id).delete();
          } catch (err) {
            console.error('delete closed date failed', err);
            const msg = (err && err.code === 'permission-denied')
              ? '臨時休業日の削除に権限がありません。'
              : '削除に失敗しました: '+(err.message||err);
            alert(msg);
          }
        });
        right.appendChild(del);

        row.appendChild(left);
        row.appendChild(right);
        list.appendChild(row);
      });
    }, err => {
      console.error('watchClosedDates error', err);
      if (err && err.code === 'permission-denied') {
        document.getElementById('closedList').innerHTML = '<div style="color:#a00">臨時休業日の表示に権限がありません。管理者に問い合わせてください。</div>';
      } else {
        document.getElementById('closedList').innerHTML = '<div style="color:#a00">読み込みに失敗しました: '+(err.message||err)+'</div>';
      }
    });
  }
</script>
</body>
</html>
