<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>清水の森 - カレンダー編集</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css?v=1.3">
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h1 style="margin:0">カレンダー編集</h1>
      <div>
        <button id="backBtn" class="act-btn">予約管理に戻る</button>
      </div>
    </div>

    <p>ここでは臨時休業日を追加・削除できます。<br>
    ※ 毎週日曜・第2・第4月曜はデフォルトで休業扱いになります（編集不要）。</p>

    <label>
      休業日（個別追加）:
      <input type="date" id="closedDate" />
      <button id="addClosedBtn" class="act-btn">追加</button>
    </label>

    <h3>登録済みの臨時休業日</h3>
    <div id="closedList"></div>

    <!-- カレンダープレビュー（今月・来月） -->
    <section id="calendarPreviewSection" style="grid-column:1/-1;margin-top:18px;">
      <h3 style="margin:8px 0 12px 0;color:#6b4423;">カレンダー（今月 / 来月）</h3>
      <div id="calendarPreview" class="calendar-preview" role="region" aria-live="polite">
        <!-- JS がここに2つの月カレンダーを描画します -->
      </div>
    </section>
  </div>

  <!-- 日別予約モーダル（閲覧＋新規予約） -->
  <div id="dayModal" style="display:none;">
    <div id="dayModalBackdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:100000;"></div>
    <div id="dayModalContent" role="dialog" aria-modal="true"
         style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:10px;z-index:100001;min-width:320px;max-width:920px;box-shadow:0 10px 30px rgba(0,0,0,0.25);">
      <h3 id="dayModalTitle" style="margin:0 0 10px 0;color:#6b4423;">日付の予約</h3>
      <div id="dayModalInfo" style="margin-bottom:10px;color:#333;font-size:0.95rem;"></div>

      <!-- 既存予約一覧 -->
      <div id="dayModalList" style="max-height:36vh; overflow:auto; margin-bottom:12px;"></div>

      <hr style="border:none;border-top:1px solid #eee;margin:12px 0;">

      <!-- 新規予約フォーム -->
      <div id="newResForm" style="margin-bottom:8px;">
        <div style="font-weight:700;margin-bottom:8px;color:#6b4423;">この日で新規予約を作成</div>

        <!-- 時間選択（動的に11:00/13:00/dinnerを表示） -->
        <div id="timeOptions" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;"></div>

        <!-- 空いているテーブル（選択可） -->
        <div style="margin-bottom:8px;">
          <div style="font-weight:600;margin-bottom:6px;">空きテーブル（クリックで選択）</div>
          <div id="availableTables" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
          <div id="noTablesMsg" style="color:#a00;margin-top:6px;display:none;">選択した時間帯に空きテーブルがありません。</div>
        </div>

        <!-- ユーザー入力 -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin-bottom:8px;">
          <input id="resName" type="text" placeholder="予約者名（必須）" />
          <input id="resTel" type="text" placeholder="電話番号" />
          <input id="resNumAdult" type="number" min="0" placeholder="大人数" />
          <input id="resNumChild" type="number" min="0" placeholder="子供数" />
        </div>
        <textarea id="resNote" placeholder="備考（任意）" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;"></textarea>

        <!-- 担当者（現在のユーザーをデフォルト） -->
        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-bottom:8px;">
          <label style="font-weight:600;color:#6b4423;">担当者</label>
          <input id="resStaff" type="text" readonly style="background:#f3f0e6;padding:6px;border-radius:6px;border:1px solid #e3d9c6;" />
        </div>

        <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end;">
          <button id="cancelNewResBtn" class="act-btn" style="background:linear-gradient(90deg,#c4c4c4,#e0e0e0);color:#333;padding:8px 12px;border-radius:8px;">キャンセル</button>
          <button id="createNewResBtn" class="act-btn" style="background:linear-gradient(90deg,#e69527,#c38b2a);color:#fff;padding:8px 12px;border-radius:8px;">予約する</button>
        </div>
      </div>

    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCIjAeYqS2Bbw60qU6ZUn2q04TlMFD5fdg",
    authDomain: "website-create-shimizunomori.firebaseapp.com",
    projectId: "website-create-shimizunomori",
    storageBucket: "website-create-shimizunomori.appspot.com",
    messagingSenderId: "356236905700",
    appId: "1:356236905700:web:fdae74bcebb1e29856b0f1",
    measurementId: "G-69W2528VVT"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // auth guard
  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }
    // else: load list and render calendars
    watchClosedDates();
    renderCalendarsPreview().catch(e => console.error(e));
  });

  document.getElementById('backBtn').addEventListener('click', ()=> {
    window.location.href = 'index.html';
  });

  // helper: Japanese weekday label for YYYY-MM-DD
  function weekdayLabelFromYMD(ymd) {
    if (!ymd) return '';
    const d = new Date(ymd + 'T00:00:00');
    if (isNaN(d)) return '';
    const labels = ['日','月','火','水','木','金','土'];
    return labels[d.getDay()];
  }

  // add closed date: now + 365 days expireAt
  document.getElementById('addClosedBtn').addEventListener('click', async () => {
    const inp = document.getElementById('closedDate');
    const val = inp.value;
    if (!val) { alert('日付を選択してください'); return; }

    try {
      const now = new Date();
      const expireDate = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000);
      const expireAt = firebase.firestore.Timestamp.fromDate(expireDate);

      await db.collection('closed_dates').doc(val).set({
        date: val,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        expireAt: expireAt
      });
      inp.value = '';
    } catch (err) {
      console.error('add closed date failed', err);
      const msg = (err && err.code === 'permission-denied')
        ? '臨時休業日の追加に権限がありません。'
        : '追加に失敗しました: ' + (err.message || err);
      alert(msg);
    }
  });

  // list and watch closed_dates (display date with weekday e.g. 2026-01-22(木))
  function watchClosedDates() {
    const list = document.getElementById('closedList');
    list.innerHTML = '<div style="color:#666">読み込み中...</div>';
    db.collection('closed_dates').orderBy('date','desc').onSnapshot(snapshot => {
      list.innerHTML = '';
      if (snapshot.empty) {
        list.innerHTML = '<div style="color:#666">登録された臨時休業日はありません。</div>';
        return;
      }
      snapshot.docs.forEach(doc => {
        const d = doc.data();
        const displayDate = d.date || doc.id;
        const wd = weekdayLabelFromYMD(displayDate);
        const text = wd ? `${displayDate}(${wd})` : displayDate;

        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.padding = '6px 0';

        const left = document.createElement('div');
        left.textContent = text;

        const right = document.createElement('div');
        const del = document.createElement('button');
        del.className = 'act-btn';
        del.textContent = '削除';
        del.addEventListener('click', async () => {
          if (!confirm(`${text} を臨時休業日から削除しますか？`)) return;
          try {
            await db.collection('closed_dates').doc(doc.id).delete();
          } catch (err) {
            console.error('delete closed date failed', err);
            const msg = (err && err.code === 'permission-denied')
              ? '臨時休業日の削除に権限がありません。'
              : '削除に失敗しました: '+(err.message||err);
            alert(msg);
          }
        });
        right.appendChild(del);

        row.appendChild(left);
        row.appendChild(right);
        list.appendChild(row);
      });
    }, err => {
      console.error('watchClosedDates error', err);
      if (err && err.code === 'permission-denied') {
        document.getElementById('closedList').innerHTML = '<div style="color:#a00">臨時休業日の表示に権限がありません。管理者に問い合わせてください。</div>';
      } else {
        document.getElementById('closedList').innerHTML = '<div style="color:#a00">読み込みに失敗しました: '+(err.message||err)+'</div>';
      }
    });
  }

  /* ------------------ カレンダープレビュー機能 ------------------ */
  const TABLE_CAPACITY = {"T1":4,"T2":4,"T4":2,"T5":2,"T6":2,"T7":2,"T8":2,"T9":2,"T10":2};
  const TABLES = Object.keys(TABLE_CAPACITY);
  const TOTAL_SEATS = TABLES.reduce((s, t) => s + (TABLE_CAPACITY[t]||0), 0);

  let _closedDatesSet_forCalendar = new Set();

  async function loadClosedDatesForCalendar() {
    try {
      const snap = await db.collection('closed_dates').get();
      _closedDatesSet_forCalendar.clear();
      snap.docs.forEach(d => { const data = d.data(); if (data && data.date) _closedDatesSet_forCalendar.add(data.date); });
    } catch (e) {
      console.warn('closed_dates load failed', e);
    }
  }

  function isDefaultClosed(dateObj) {
    if (!dateObj || !(dateObj instanceof Date)) return false;
    const day = dateObj.getDay();
    if (day === 0) return true; // Sunday
    if (day === 1) {
      const year = dateObj.getFullYear();
      const month = dateObj.getMonth();
      let mondayCount = 0;
      for (let d = 1; d <= dateObj.getDate(); d++) {
        const dt = new Date(year, month, d);
        if (dt.getDay() === 1) mondayCount++;
      }
      if (mondayCount === 2 || mondayCount === 4) return true;
    }
    return false;
  }

  function ymdString(d) {
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  async function fetchReservationsSummary(startYmd, endYmd) {
    const resMap = {};
    try {
      const q = db.collection('shimizu_cafe_reservations').where('date', '>=', startYmd).where('date', '<=', endYmd);
      const snap = await q.get();
      snap.docs.forEach(doc => {
        const r = doc.data();
        if (!r || !r.date) return;
        const date = r.date;
        const time = r.time || '';
        const tables = Array.isArray(r.tables) ? r.tables : [];
        const reservedSeats = (tables || []).reduce((s,tNo) => s + (TABLE_CAPACITY[tNo]||0), 0);
        if (!resMap[date]) resMap[date] = {};
        resMap[date][time] = (resMap[date][time]||0) + reservedSeats;
      });
    } catch (err) {
      console.error('fetchReservationsSummary fail', err);
    }
    return resMap;
  }

  // buildMonthGrid (ランチ判定を 11:00 / 13:00 個別で評価し、金土は 11/13/ディナー 表示)
  function buildMonthGrid(year, month, resSummary) {
    const first = new Date(year, month, 1);
    const last = new Date(year, month + 1, 0);
    const grid = [];
    const startDate = new Date(first);
    startDate.setDate(first.getDate() - first.getDay());
    const endDate = new Date(last);
    endDate.setDate(last.getDate() + (6 - last.getDay()));

    let cur = new Date(startDate);
    while (cur <= endDate) {
      const week = [];
      for (let i = 0; i < 7; i++) {
        const cellDate = new Date(cur);
        const ymd = ymdString(cellDate);
        const isClosed = _closedDatesSet_forCalendar.has(ymd) || isDefaultClosed(cellDate);

        const daySummary = (resSummary && resSummary[ymd]) ? resSummary[ymd] : {};
        const reserved11 = Number(daySummary['11:00'] || 0);
        const reserved13 = Number(daySummary['13:00'] || 0);
        const reservedDinner = Number(daySummary['dinner'] || 0);

        const lunchFull = (reserved11 >= TOTAL_SEATS) && (reserved13 >= TOTAL_SEATS);
        const dinnerFull = (reservedDinner >= TOTAL_SEATS);

        const tooltip = `11:00: ${reserved11} / 13:00: ${reserved13} / ディナー: ${reservedDinner}`;

        week.push({
          date: new Date(cellDate),
          ymd,
          isCurrentMonth: cellDate.getMonth() === month,
          isClosed,
          lunchFull,
          dinnerFull,
          reserved11,
          reserved13,
          reservedDinner,
          tooltip
        });

        cur.setDate(cur.getDate() + 1);
      }
      grid.push(week);
    }
    return { grid, first, last };
  }

  function renderCalendarPreviewInto(containerEl, year, month, resSummary) {
    const mb = document.createElement('div'); mb.className = 'month-box';
    const title = document.createElement('div'); title.className = 'month-title';
    const mm = month + 1;
    title.textContent = `${year}年 ${mm}月`;
    mb.appendChild(title);

    const weekdays = document.createElement('div'); weekdays.className = 'weekdays';
    ['日','月','火','水','木','金','土'].forEach(w => {
      const el = document.createElement('div'); el.textContent = w; weekdays.appendChild(el);
    });
    mb.appendChild(weekdays);

    const { grid } = buildMonthGrid(year, month, resSummary);
    const daysGrid = document.createElement('div'); daysGrid.className = 'days-grid';

    grid.forEach(week => {
      week.forEach(cell => {
        const d = document.createElement('div');
        d.className = 'day-cell' + (cell.isCurrentMonth ? '' : ' inactive');
        d.setAttribute('data-ymd', cell.ymd);
        d.title = cell.tooltip || '';

        const num = document.createElement('div'); num.className = 'day-num'; num.textContent = cell.date.getDate();
        d.appendChild(num);

        // top: 11 / 13 badges (visual indicator)
        const lunchRow = document.createElement('div');
        lunchRow.style.display = 'flex';
        lunchRow.style.gap = '6px';
        lunchRow.style.marginBottom = '6px';
        lunchRow.style.justifyContent = 'center';
        // 11:00 badge
        const badge11 = document.createElement('div');
        badge11.textContent = '11';
        badge11.className = (cell.reserved11 >= TOTAL_SEATS) ? 'badge badge-full' : 'badge badge-available';
        badge11.style.padding = '4px 6px';
        badge11.style.borderRadius = '6px';
        badge11.style.fontWeight = '700';
        badge11.style.fontSize = '0.8rem';
        badge11.style.color = '#fff';
        lunchRow.appendChild(badge11);
        // 13:00 badge
        const badge13 = document.createElement('div');
        badge13.textContent = '13';
        badge13.className = (cell.reserved13 >= TOTAL_SEATS) ? 'badge badge-full' : 'badge badge-available';
        badge13.style.padding = '4px 6px';
        badge13.style.borderRadius = '6px';
        badge13.style.fontWeight = '700';
        badge13.style.fontSize = '0.8rem';
        badge13.style.color = '#fff';
        lunchRow.appendChild(badge13);
        d.appendChild(lunchRow);

        const st = document.createElement('div'); st.className = 'status';

        if (cell.isClosed) {
          const b = document.createElement('div'); b.className = 'badge badge-closed'; b.textContent = '休'; st.appendChild(b);
        } else {
          const dow = cell.date.getDay();
          if (dow === 5 || dow === 6) {
            // Friday / Saturday: bottom shows only a single "ディナー" badge
            const dinnerBadge = document.createElement('div');
            dinnerBadge.textContent = 'ディナー';
            dinnerBadge.className = (cell.reservedDinner >= TOTAL_SEATS) ? 'badge badge-full' : 'badge badge-available';
            dinnerBadge.style.padding = '6px 10px';
            dinnerBadge.style.borderRadius = '8px';
            dinnerBadge.style.fontWeight = '700';
            dinnerBadge.style.fontSize = '0.9rem';
            st.appendChild(dinnerBadge);
          } else {
            const combinedFull = cell.lunchFull;
            const b = document.createElement('div');
            b.className = 'badge ' + (combinedFull ? 'badge-full' : 'badge-available');
            b.textContent = combinedFull ? '満' : '空';
            st.appendChild(b);
          }
        }

        d.appendChild(st);

        // click -> open day modal listing reservations for this date and show new-res form
        d.style.cursor = 'pointer';
        d.addEventListener('click', (ev) => {
          ev.stopPropagation();
          showDayReservations(cell.ymd);
        });

        daysGrid.appendChild(d);
      });
    });

    mb.appendChild(daysGrid);
    containerEl.appendChild(mb);
  }

  // show a modal listing reservations for a given YYYY-MM-DD
  // extended: also render available tables per time and allow creating reservation
  async function showDayReservations(ymd) {
    const modal = document.getElementById('dayModal');
    const infoEl = document.getElementById('dayModalInfo');
    const listEl = document.getElementById('dayModalList');
    const titleEl = document.getElementById('dayModalTitle');
    const timeOptionsEl = document.getElementById('timeOptions');
    const availableTablesEl = document.getElementById('availableTables');
    const noTablesMsg = document.getElementById('noTablesMsg');
    const resStaffInput = document.getElementById('resStaff');

    if (!modal || !listEl || !infoEl) return;

    titleEl.textContent = `予約一覧 — ${ymd}`;
    infoEl.textContent = '読み込み中...';
    listEl.innerHTML = '';
    timeOptionsEl.innerHTML = '';
    availableTablesEl.innerHTML = '';
    noTablesMsg.style.display = 'none';

    // prefill staff input
    const user = firebase.auth().currentUser;
    resStaffInput.value = (user && (user.displayName || user.email)) || '';

    modal.style.display = 'block';
    document.getElementById('dayModalContent').focus?.();

    try {
      // fetch all reservations for this date
      const snap = await db.collection('shimizu_cafe_reservations').where('date','==',ymd).orderBy('time').get();
      const docs = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      // show existing reservations grouped by time
      listEl.innerHTML = '';
      if (docs.length === 0) {
        listEl.innerHTML = '<div style="color:#666">予約はありません</div>';
      } else {
        const grouped = {};
        docs.forEach(r => {
          const t = r.time || '(不明)';
          if (!grouped[t]) grouped[t] = [];
          grouped[t].push(r);
        });
        Object.keys(grouped).sort().forEach(timeKey => {
          const hdr = document.createElement('div');
          hdr.style.fontWeight = '700';
          hdr.style.marginTop = '8px';
          hdr.style.marginBottom = '6px';
          hdr.textContent = `時間: ${timeKey}`;
          listEl.appendChild(hdr);

          const tbl = document.createElement('table');
          tbl.style.width = '100%';
          tbl.style.borderCollapse = 'collapse';
          tbl.style.marginBottom = '8px';
          const thead = document.createElement('thead');
          thead.innerHTML = '<tr><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">テーブル</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">人数</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">名前</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">担当者</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">備考</th></tr>';
          tbl.appendChild(thead);
          const tbody = document.createElement('tbody');
          grouped[timeKey].forEach(r => {
            const tr = document.createElement('tr');
            const tdTables = document.createElement('td'); tdTables.style.padding = '6px'; tdTables.textContent = (r.tables||[]).join(', ');
            const tdNum = document.createElement('td'); tdNum.style.padding = '6px'; tdNum.textContent = `${r.numAdult||0} / ${r.numChild||0}`;
            const tdName = document.createElement('td'); tdName.style.padding = '6px'; tdName.textContent = r.name || '';
            const tdStaff = document.createElement('td'); tdStaff.style.padding = '6px'; tdStaff.textContent = r.staff || '';
            const tdNote = document.createElement('td'); tdNote.style.padding = '6px'; tdNote.textContent = r.note || '';
            tr.appendChild(tdTables); tr.appendChild(tdNum); tr.appendChild(tdName); tr.appendChild(tdStaff); tr.appendChild(tdNote);
            tbody.appendChild(tr);
          });
          tbl.appendChild(tbody);
          listEl.appendChild(tbl);
        });
      }

      // compute used tables per time
      const usedByTime = {}; // timeKey -> Set(tables)
      docs.forEach(r => {
        const t = r.time || '';
        if (!usedByTime[t]) usedByTime[t] = new Set();
        (r.tables||[]).forEach(tn => usedByTime[t].add(tn));
      });

      // determine which time options to show: always show 11:00,13:00;
      // show dinner if weekday is Fri/Sat (or if any dinner reservations exist)
      const dateObj = new Date(ymd + 'T00:00:00');
      const dow = dateObj.getDay();
      const showDinner = (dow === 5 || dow === 6) || !!usedByTime['dinner'];

      const timeKeys = ['11:00','13:00'];
      if (showDinner) timeKeys.push('dinner');

      // render time option radios
      timeKeys.forEach((tk, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = tk === 'dinner' ? 'ディナー' : tk;
        btn.className = 'act-btn';
        btn.style.padding = '6px 10px';
        btn.style.borderRadius = '8px';
        btn.dataset.time = tk;
        btn.style.background = idx === 0 ? 'linear-gradient(90deg,#e69527,#c38b2a)' : 'linear-gradient(90deg,#f0d9a8,#e6c889)';
        btn.style.color = idx === 0 ? '#fff' : '#5a3e1d';
        // select first by default
        btn.addEventListener('click', (e) => {
          // mark selected visual
          Array.from(timeOptionsEl.children).forEach(c => {
            c.style.background = 'linear-gradient(90deg,#f0d9a8,#e6c889)';
            c.style.color = '#5a3e1d';
          });
          btn.style.background = 'linear-gradient(90deg,#e69527,#c38b2a)';
          btn.style.color = '#fff';
          // render available tables for this time
          renderAvailableTablesFor(ymd, tk, usedByTime);
        });
        timeOptionsEl.appendChild(btn);
      });

      // trigger initial render for first time key
      const firstTime = timeKeys[0];
      // highlight first
      if (timeOptionsEl.firstChild) {
        timeOptionsEl.firstChild.style.background = 'linear-gradient(90deg,#e69527,#c38b2a)';
        timeOptionsEl.firstChild.style.color = '#fff';
      }
      renderAvailableTablesFor(ymd, firstTime, usedByTime);

    } catch (err) {
      console.error('day reservations fetch failed', err);
      infoEl.textContent = '読み込みに失敗しました: ' + (err.message || err);
    }
  }

  // render available tables UI for a given date/time using precomputed usedByTime map
  function renderAvailableTablesFor(ymd, timeKey, usedByTime) {
    const availableTablesEl = document.getElementById('availableTables');
    const noTablesMsg = document.getElementById('noTablesMsg');
    availableTablesEl.innerHTML = '';

    // compute used tables for selected time
    const usedSet = (usedByTime && usedByTime[timeKey]) ? usedByTime[timeKey] : new Set();

    // available = TABLES - usedSet
    const available = TABLES.filter(t => !usedSet.has(t));

    if (available.length === 0) {
      noTablesMsg.style.display = 'block';
    } else {
      noTablesMsg.style.display = 'none';
      available.forEach(t => {
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = t;
        b.dataset.table = t;
        b.className = 'act-btn';
        b.style.padding = '6px 10px';
        b.style.borderRadius = '8px';
        b.style.background = '#6b9a5a';
        b.style.color = '#fff';
        b.style.fontWeight = '700';
        b.addEventListener('click', () => {
          // toggle selection state
          if (b.dataset.selected === '1') {
            b.dataset.selected = '0';
            b.style.opacity = '1';
            b.style.boxShadow = 'none';
            b.style.background = '#6b9a5a';
          } else {
            b.dataset.selected = '1';
            b.style.opacity = '0.95';
            b.style.boxShadow = 'inset 0 0 0 3px rgba(255,255,255,0.14)';
            b.style.background = '#335e3a';
          }
        });
        availableTablesEl.appendChild(b);
      });
    }

    // store current selection state in create handler by reading buttons
    // Also attach current timeKey to create button's dataset for convenience
    const createBtn = document.getElementById('createNewResBtn');
    if (createBtn) createBtn.dataset.time = timeKey;

    // set data attribute on availableTablesEl for the date/time (for create handler)
    availableTablesEl.dataset.ymd = ymd;
    availableTablesEl.dataset.time = timeKey;
  }

  // create reservation handler
  document.getElementById('createNewResBtn').addEventListener('click', async () => {
    const createBtn = document.getElementById('createNewResBtn');
    const availableTablesEl = document.getElementById('availableTables');
    const ymd = availableTablesEl.dataset.ymd;
    const timeKey = createBtn.dataset.time;
    if (!ymd || !timeKey) {
      alert('日時が取得できません。もう一度お試しください。'); return;
    }

    // collect selected tables
    const selButtons = Array.from(availableTablesEl.querySelectorAll('button')).filter(b => b.dataset.selected === '1');
    if (selButtons.length === 0) {
      alert('空きテーブルを１つ以上選択してください。'); return;
    }
    const tables = selButtons.map(b => b.dataset.table);

    const name = (document.getElementById('resName') || {}).value?.trim();
    const tel = (document.getElementById('resTel') || {}).value?.trim() || '';
    const numAdult = Number((document.getElementById('resNumAdult') || {}).value) || 0;
    const numChild = Number((document.getElementById('resNumChild') || {}).value) || 0;
    const note = (document.getElementById('resNote') || {}).value || '';
    const staff = (document.getElementById('resStaff') || {}).value || (firebase.auth().currentUser && (firebase.auth().currentUser.displayName || firebase.auth().currentUser.email)) || '';

    if (!name) { alert('予約者名は必須です'); (document.getElementById('resName') || {}).focus?.(); return; }
    if (!staff) { alert('担当者情報がありません。ログイン情報を確認してください。'); return; }

    // prepare reservation doc
    const doc = {
      date: ymd,
      time: timeKey,
      tables: tables,
      numAdult: numAdult,
      numChild: numChild,
      name: name,
      tel: tel,
      note: note,
      staff: staff,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      // Optionally: double-check tables are still free (simple check)
      // fetch existing reservations for same date & time and ensure no overlap
      const snap = await db.collection('shimizu_cafe_reservations').where('date','==',ymd).where('time','==',timeKey).get();
      const used = new Set();
      snap.docs.forEach(d => { (d.data().tables || []).forEach(t => used.add(t)); });

      const conflict = tables.find(t => used.has(t));
      if (conflict) {
        alert(`テーブル ${conflict} が既に埋まっています。最新の空き状態に更新します。`);
        // re-render available tables for same ymd/time by re-fetching reservations via showDayReservations
        await showDayReservations(ymd);
        return;
      }

      // write reservation
      await db.collection('shimizu_cafe_reservations').add(doc);
      alert('予約を作成しました');
      // close modal and refresh calendars
      document.getElementById('dayModal').style.display = 'none';
      // refresh calendar preview
      try { await renderCalendarsPreview(); } catch(e) { console.error(e); }
    } catch (err) {
      console.error('create reservation failed', err);
      alert('予約の作成に失敗しました: ' + (err.message || err));
    }
  });

  // cancel new res button
  document.getElementById('cancelNewResBtn').addEventListener('click', () => {
    const modal = document.getElementById('dayModal');
    if (modal) modal.style.display = 'none';
  });

  // close modal handlers
  document.getElementById('dayModalBackdrop').addEventListener('click', () => {
    const modal = document.getElementById('dayModal');
    if (modal) modal.style.display = 'none';
  });

  async function renderCalendarsPreview() {
    const container = document.getElementById('calendarPreview');
    if (!container) return;
    container.innerHTML = '';
    await loadClosedDatesForCalendar();

    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth() + 2, 0);
    const startYmd = ymdString(start);
    const endYmd = ymdString(end);

    const resSummary = await fetchReservationsSummary(startYmd, endYmd);

    const cYear = now.getFullYear();
    const cMonth = now.getMonth();
    renderCalendarPreviewInto(container, cYear, cMonth, resSummary);
    renderCalendarPreviewInto(container, cYear + (cMonth === 11 ? 1 : 0), (cMonth + 1) % 12, resSummary);
  }

  // End calendar preview
</script>
</body>
</html>
