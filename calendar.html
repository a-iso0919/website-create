<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>清水の森 - カレンダー編集</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css?v=1.3">
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h1 style="margin:0">カレンダー編集</h1>
      <div>
        <button id="backBtn" class="act-btn">予約管理に戻る</button>
      </div>
    </div>

    <p>ここでは臨時休業日を追加・削除できます。<br>
    ※ 毎週日曜・第2・第4月曜はデフォルトで休業扱いになります（編集不要）。</p>

    <label>
      休業日（個別追加）:
      <input type="date" id="closedDate" />
      <button id="addClosedBtn" class="act-btn">追加</button>
    </label>

    <h3>登録済みの臨時休業日</h3>
    <div id="closedList"></div>

    <!-- カレンダープレビュー（今月・来月） -->
    <section id="calendarPreviewSection" style="grid-column:1/-1;margin-top:18px;">
      <h3 style="margin:8px 0 12px 0;color:#6b4423;">カレンダー（今月 / 来月）</h3>
      <div id="calendarPreview" class="calendar-preview" role="region" aria-live="polite">
        <!-- JS がここに2つの月カレンダーを描画します -->
      </div>
    </section>
  </div>

  <!-- 日別予約モーダル（閲覧用） -->
  <div id="dayModal" style="display:none;">
    <div id="dayModalBackdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:100000;"></div>
    <div id="dayModalContent" role="dialog" aria-modal="true" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:10px;z-index:100001;min-width:320px;max-width:860px;box-shadow:0 10px 30px rgba(0,0,0,0.25);">
      <h3 id="dayModalTitle" style="margin:0 0 10px 0;color:#6b4423;">日付の予約</h3>
      <div id="dayModalInfo" style="margin-bottom:10px;color:#333;font-size:0.95rem;"></div>
      <div id="dayModalList" style="max-height:50vh; overflow:auto; margin-bottom:12px;"></div>
      <div style="text-align:right;">
        <button id="closeDayModalBtn" class="act-btn" style="background:linear-gradient(90deg,#c4c4c4,#e0e0e0);color:#333;padding:8px 12px;border-radius:8px;">閉じる</button>
      </div>
    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCIjAeYqS2Bbw60qU6ZUn2q04TlMFD5fdg",
    authDomain: "website-create-shimizunomori.firebaseapp.com",
    projectId: "website-create-shimizunomori",
    storageBucket: "website-create-shimizunomori.appspot.com",
    messagingSenderId: "356236905700",
    appId: "1:356236905700:web:fdae74bcebb1e29856b0f1",
    measurementId: "G-69W2528VVT"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // auth guard
  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }
    // else: load list and render calendars
    watchClosedDates();
    renderCalendarsPreview().catch(e => console.error(e));
  });

  document.getElementById('backBtn').addEventListener('click', ()=> {
    window.location.href = 'index.html';
  });

  // helper: Japanese weekday label for YYYY-MM-DD
  function weekdayLabelFromYMD(ymd) {
    if (!ymd) return '';
    const d = new Date(ymd + 'T00:00:00');
    if (isNaN(d)) return '';
    const labels = ['日','月','火','水','木','金','土'];
    return labels[d.getDay()];
  }

  // add closed date: now + 365 days expireAt
  document.getElementById('addClosedBtn').addEventListener('click', async () => {
    const inp = document.getElementById('closedDate');
    const val = inp.value;
    if (!val) { alert('日付を選択してください'); return; }

    try {
      // compute expireAt = now + 365 days
      const now = new Date();
      const expireDate = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000);
      const expireAt = firebase.firestore.Timestamp.fromDate(expireDate);

      // Use doc id = YYYY-MM-DD for easy upsert / delete and set createdAt + expireAt
      await db.collection('closed_dates').doc(val).set({
        date: val,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        expireAt: expireAt
      });
      inp.value = '';
    } catch (err) {
      console.error('add closed date failed', err);
      const msg = (err && err.code === 'permission-denied')
        ? '臨時休業日の追加に権限がありません。'
        : '追加に失敗しました: ' + (err.message || err);
      alert(msg);
    }
  });

  // list and watch closed_dates (display date with weekday e.g. 2026-01-22(木))
  function watchClosedDates() {
    const list = document.getElementById('closedList');
    list.innerHTML = '<div style="color:#666">読み込み中...</div>';
    db.collection('closed_dates').orderBy('date','desc').onSnapshot(snapshot => {
      list.innerHTML = '';
      if (snapshot.empty) {
        list.innerHTML = '<div style="color:#666">登録された臨時休業日はありません。</div>';
        return;
      }
      snapshot.docs.forEach(doc => {
        const d = doc.data();
        const displayDate = d.date || doc.id;
        const wd = weekdayLabelFromYMD(displayDate);
        const text = wd ? `${displayDate}(${wd})` : displayDate;

        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.padding = '6px 0';

        const left = document.createElement('div');
        left.textContent = text;

        const right = document.createElement('div');
        const del = document.createElement('button');
        del.className = 'act-btn';
        del.textContent = '削除';
        del.addEventListener('click', async () => {
          if (!confirm(`${text} を臨時休業日から削除しますか？`)) return;
          try {
            await db.collection('closed_dates').doc(doc.id).delete();
          } catch (err) {
            console.error('delete closed date failed', err);
            const msg = (err && err.code === 'permission-denied')
              ? '臨時休業日の削除に権限がありません。'
              : '削除に失敗しました: '+(err.message||err);
            alert(msg);
          }
        });
        right.appendChild(del);

        row.appendChild(left);
        row.appendChild(right);
        list.appendChild(row);
      });
    }, err => {
      console.error('watchClosedDates error', err);
      if (err && err.code === 'permission-denied') {
        document.getElementById('closedList').innerHTML = '<div style="color:#a00">臨時休業日の表示に権限がありません。管理者に問い合わせてください。</div>';
      } else {
        document.getElementById('closedList').innerHTML = '<div style="color:#a00">読み込みに失敗しました: '+(err.message||err)+'</div>';
      }
    });
  }

  /* ------------------ カレンダープレビュー機能 ------------------ */
  // テーブル定義（index.html と同じものをここにコピー）
  const TABLE_CAPACITY = {"T1":4,"T2":4,"T4":2,"T5":2,"T6":2,"T7":2,"T8":2,"T9":2,"T10":2};
  const TABLES = Object.keys(TABLE_CAPACITY);
  const TOTAL_SEATS = TABLES.reduce((s, t) => s + (TABLE_CAPACITY[t]||0), 0);

  // closed dates set used for preview (loaded from closed_dates collection)
  let _closedDatesSet_forCalendar = new Set();

  async function loadClosedDatesForCalendar() {
    try {
      const snap = await db.collection('closed_dates').get();
      _closedDatesSet_forCalendar.clear();
      snap.docs.forEach(d => { const data = d.data(); if (data && data.date) _closedDatesSet_forCalendar.add(data.date); });
    } catch (e) {
      console.warn('closed_dates load failed', e);
    }
  }

  // isDefaultClosed (same logic as index): Sunday and 2nd/4th Monday
  function isDefaultClosed(dateObj) {
    if (!dateObj || !(dateObj instanceof Date)) return false;
    const day = dateObj.getDay();
    if (day === 0) return true; // Sunday
    if (day === 1) {
      const year = dateObj.getFullYear();
      const month = dateObj.getMonth();
      let mondayCount = 0;
      for (let d = 1; d <= dateObj.getDate(); d++) {
        const dt = new Date(year, month, d);
        if (dt.getDay() === 1) mondayCount++;
      }
      if (mondayCount === 2 || mondayCount === 4) return true;
    }
    return false;
  }

  // YYYY-MM-DD string helper
  function ymdString(d) {
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  // Fetch reservations in date range and summarize reserved seats per date/time
  async function fetchReservationsSummary(startYmd, endYmd) {
    const resMap = {}; // resMap[date][timeKey] = totalReservedSeats
    try {
      const q = db.collection('shimizu_cafe_reservations').where('date', '>=', startYmd).where('date', '<=', endYmd);
      const snap = await q.get();
      snap.docs.forEach(doc => {
        const r = doc.data();
        if (!r || !r.date) return;
        const date = r.date;
        const time = r.time || '';
        const tables = Array.isArray(r.tables) ? r.tables : [];
        const reservedSeats = (tables || []).reduce((s,tNo) => s + (TABLE_CAPACITY[tNo]||0), 0);
        if (!resMap[date]) resMap[date] = {};
        const key = time;
        resMap[date][key] = (resMap[date][key]||0) + reservedSeats;
      });
    } catch (err) {
      console.error('fetchReservationsSummary fail', err);
    }
    return resMap;
  }

  // buildMonthGrid (ランチ判定を 11:00 / 13:00 個別で評価し、金土は 11/13/ディナー 表示)
  function buildMonthGrid(year, month, resSummary) {
    const first = new Date(year, month, 1);
    const last = new Date(year, month + 1, 0);
    const grid = [];
    // 開始は 1日のある週の Sunday
    const startDate = new Date(first);
    startDate.setDate(first.getDate() - first.getDay());
    // 終了は 最後日のある週の Saturday
    const endDate = new Date(last);
    endDate.setDate(last.getDate() + (6 - last.getDay()));

    let cur = new Date(startDate);
    while (cur <= endDate) {
      const week = [];
      for (let i = 0; i < 7; i++) {
        const cellDate = new Date(cur);
        const ymd = ymdString(cellDate);
        const isClosed = _closedDatesSet_forCalendar.has(ymd) || isDefaultClosed(cellDate);

        // 予約集計（存在しない場合は 0） — 11:00 / 13:00 / dinner を個別に扱う
        const daySummary = (resSummary && resSummary[ymd]) ? resSummary[ymd] : {};
        const reserved11 = Number(daySummary['11:00'] || 0);
        const reserved13 = Number(daySummary['13:00'] || 0);
        const reservedDinner = Number(daySummary['dinner'] || 0);

        // ランチは「11:00 と 13:00 が両方満席のときだけ満とする」
        // （片方でも空きがあれば '空' を表示するという要件）
        const lunchFull = (reserved11 >= TOTAL_SEATS) && (reserved13 >= TOTAL_SEATS);

        // ディナーは単独判定
        const dinnerFull = (reservedDinner >= TOTAL_SEATS);

        // tooltip for debug/inspection
        const tooltip = `11:00: ${reserved11} / 13:00: ${reserved13} / ディナー: ${reservedDinner}`;

        week.push({
          date: new Date(cellDate),
          ymd,
          isCurrentMonth: cellDate.getMonth() === month,
          isClosed,
          lunchFull,
          dinnerFull,
          reserved11,
          reserved13,
          reservedDinner,
          tooltip
        });

        cur.setDate(cur.getDate() + 1);
      }
      grid.push(week);
    }
    return { grid, first, last };
  }

  function renderCalendarPreviewInto(containerEl, year, month, resSummary) {
    const mb = document.createElement('div'); mb.className = 'month-box';
    const title = document.createElement('div'); title.className = 'month-title';
    const mm = month + 1;
    title.textContent = `${year}年 ${mm}月`;
    mb.appendChild(title);

    const weekdays = document.createElement('div'); weekdays.className = 'weekdays';
    ['日','月','火','水','木','金','土'].forEach(w => {
      const el = document.createElement('div'); el.textContent = w; weekdays.appendChild(el);
    });
    mb.appendChild(weekdays);

    const { grid } = buildMonthGrid(year, month, resSummary);
    const daysGrid = document.createElement('div'); daysGrid.className = 'days-grid';

    grid.forEach(week => {
      week.forEach(cell => {
        const d = document.createElement('div');
        d.className = 'day-cell' + (cell.isCurrentMonth ? '' : ' inactive');
        d.setAttribute('data-ymd', cell.ymd);
        d.title = cell.tooltip || '';

        const num = document.createElement('div'); num.className = 'day-num'; num.textContent = cell.date.getDate();
        d.appendChild(num);

        // -- lunch time small badges (11/13) for all days (visual indicator) --
        const lunchRow = document.createElement('div');
        lunchRow.style.display = 'flex';
        lunchRow.style.gap = '6px';
        lunchRow.style.marginBottom = '6px';
        lunchRow.style.justifyContent = 'center';
        // 11:00 badge
        const badge11 = document.createElement('div');
        badge11.textContent = '11';
        badge11.style.padding = '4px 6px';
        badge11.style.borderRadius = '6px';
        badge11.style.fontWeight = '700';
        badge11.style.fontSize = '0.8rem';
        badge11.style.color = '#fff';
        badge11.style.background = (cell.reserved11 >= TOTAL_SEATS) ? '#c04a4a' : '#6b9a5a';
        lunchRow.appendChild(badge11);
        // 13:00 badge
        const badge13 = document.createElement('div');
        badge13.textContent = '13';
        badge13.style.padding = '4px 6px';
        badge13.style.borderRadius = '6px';
        badge13.style.fontWeight = '700';
        badge13.style.fontSize = '0.8rem';
        badge13.style.color = '#fff';
        badge13.style.background = (cell.reserved13 >= TOTAL_SEATS) ? '#c04a4a' : '#6b9a5a';
        lunchRow.appendChild(badge13);
        d.appendChild(lunchRow);

        const st = document.createElement('div'); st.className = 'status';

        if (cell.isClosed) {
          const b = document.createElement('div'); b.className = 'badge badge-closed'; b.textContent = '休'; st.appendChild(b);
        } else {
          const dow = cell.date.getDay();
          if (dow === 5 || dow === 6) {
            // Friday / Saturday: show three compact badges: 11 / 13 / ディナー
            const split = document.createElement('div');
            split.style.display = 'flex';
            split.style.gap = '8px';
            split.style.width = '100%';
            split.style.justifyContent = 'center';
            split.style.alignItems = 'center';

            // 11 badge (compact)
            const small11 = document.createElement('div');
            small11.textContent = '11';
            small11.style.flex = '0 0 auto';
            small11.style.padding = '6px 8px';
            small11.style.borderRadius = '8px';
            small11.style.fontWeight = '700';
            small11.style.color = '#fff';
            small11.style.fontSize = '0.9rem';
            small11.style.background = (cell.reserved11 >= TOTAL_SEATS) ? '#c04a4a' : '#6b9a5a';
            split.appendChild(small11);

            // 13 badge (compact)
            const small13 = document.createElement('div');
            small13.textContent = '13';
            small13.style.flex = '0 0 auto';
            small13.style.padding = '6px 8px';
            small13.style.borderRadius = '8px';
            small13.style.fontWeight = '700';
            small13.style.color = '#fff';
            small13.style.fontSize = '0.9rem';
            small13.style.background = (cell.reserved13 >= TOTAL_SEATS) ? '#c04a4a' : '#6b9a5a';
            split.appendChild(small13);

            // Dinner badge (compact, labelled ディナー)
            const smallDinner = document.createElement('div');
            smallDinner.textContent = 'ディナー';
            smallDinner.style.flex = '0 0 auto';
            smallDinner.style.padding = '6px 10px';
            smallDinner.style.borderRadius = '8px';
            smallDinner.style.fontWeight = '700';
            smallDinner.style.color = '#fff';
            smallDinner.style.fontSize = '0.85rem';
            smallDinner.style.background = (cell.reservedDinner >= TOTAL_SEATS) ? '#c04a4a' : '#6b9a5a';
            split.appendChild(smallDinner);

            st.appendChild(split);
          } else {
            // Weekday: show overall badge for lunch (based on combined rule)
            const combinedFull = cell.lunchFull;
            const b = document.createElement('div');
            b.className = 'badge ' + (combinedFull ? 'badge-full' : 'badge-available');
            b.textContent = combinedFull ? '満' : '空';
            st.appendChild(b);
          }
        }

        d.appendChild(st);

        // click -> open day modal listing reservations for this date
        d.style.cursor = 'pointer';
        d.addEventListener('click', (ev) => {
          ev.stopPropagation();
          showDayReservations(cell.ymd);
        });

        daysGrid.appendChild(d);
      });
    });

    mb.appendChild(daysGrid);
    containerEl.appendChild(mb);
  }

  // show a modal listing reservations for a given YYYY-MM-DD
  async function showDayReservations(ymd) {
    const modal = document.getElementById('dayModal');
    const infoEl = document.getElementById('dayModalInfo');
    const listEl = document.getElementById('dayModalList');
    const titleEl = document.getElementById('dayModalTitle');
    if (!modal || !listEl || !infoEl) return;

    titleEl.textContent = `予約一覧 — ${ymd}`;
    infoEl.textContent = '読み込み中...';
    listEl.innerHTML = '';
    modal.style.display = 'block';
    document.getElementById('dayModalContent').focus?.();

    try {
      const snap = await db.collection('shimizu_cafe_reservations').where('date','==',ymd).orderBy('time').orderBy('createdAt').get();
      if (snap.empty) {
        infoEl.textContent = '予約はありません';
        return;
      }
      infoEl.textContent = '';
      const docs = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      // Group by time key for clarity
      const grouped = {};
      docs.forEach(r => {
        const t = r.time || '(不明)';
        if (!grouped[t]) grouped[t] = [];
        grouped[t].push(r);
      });
      // Render
      for (const timeKey of Object.keys(grouped).sort()) {
        const hdr = document.createElement('div');
        hdr.style.fontWeight = '700';
        hdr.style.marginTop = '8px';
        hdr.style.marginBottom = '6px';
        hdr.textContent = `時間: ${timeKey}`;
        listEl.appendChild(hdr);

        const tbl = document.createElement('table');
        tbl.style.width = '100%';
        tbl.style.borderCollapse = 'collapse';
        tbl.style.marginBottom = '8px';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">テーブル</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">人数</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">名前</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">電話</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">担当者</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">備考</th></tr>';
        tbl.appendChild(thead);
        const tbody = document.createElement('tbody');
        grouped[timeKey].forEach(r => {
          const tr = document.createElement('tr');
          const tdTables = document.createElement('td'); tdTables.style.padding = '6px'; tdTables.textContent = (r.tables||[]).join(', ');
          const tdNum = document.createElement('td'); tdNum.style.padding = '6px'; tdNum.textContent = `${r.numAdult||0} / ${r.numChild||0}`;
          const tdName = document.createElement('td'); tdName.style.padding = '6px'; tdName.textContent = r.name || '';
          const tdTel = document.createElement('td'); tdTel.style.padding = '6px'; tdTel.textContent = r.tel || '';
          const tdStaff = document.createElement('td'); tdStaff.style.padding = '6px'; tdStaff.textContent = r.staff || '';
          const tdNote = document.createElement('td'); tdNote.style.padding = '6px'; tdNote.textContent = r.note || '';
          tr.appendChild(tdTables); tr.appendChild(tdNum); tr.appendChild(tdName); tr.appendChild(tdTel); tr.appendChild(tdStaff); tr.appendChild(tdNote);
          tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        listEl.appendChild(tbl);
      }
    } catch (err) {
      console.error('day reservations fetch failed', err);
      infoEl.textContent = '読み込みに失敗しました: ' + (err.message || err);
    }
  }

  // close modal handlers
  document.getElementById('closeDayModalBtn').addEventListener('click', () => {
    const modal = document.getElementById('dayModal');
    if (modal) modal.style.display = 'none';
  });
  document.getElementById('dayModalBackdrop').addEventListener('click', () => {
    const modal = document.getElementById('dayModal');
    if (modal) modal.style.display = 'none';
  });

  async function renderCalendarsPreview() {
    const container = document.getElementById('calendarPreview');
    if (!container) return;
    container.innerHTML = '';
    await loadClosedDatesForCalendar();

    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth() + 2, 0);
    const startYmd = ymdString(start);
    const endYmd = ymdString(end);

    const resSummary = await fetchReservationsSummary(startYmd, endYmd);

    const cYear = now.getFullYear();
    const cMonth = now.getMonth();
    renderCalendarPreviewInto(container, cYear, cMonth, resSummary);
    renderCalendarPreviewInto(container, cYear + (cMonth === 11 ? 1 : 0), (cMonth + 1) % 12, resSummary);
  }

  // End calendar preview
</script>
</body>
</html>
